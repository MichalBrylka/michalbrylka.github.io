<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Generic math extended example - Michał Bryłka | Devexcellence</title><meta name=Description content="Michał Bryłka | Devexcellence blog"><meta property="og:title" content="Generic math extended example"><meta property="og:description" content="Generic math feature from C# 11 brings us a lot of flexibility. Besides ubiquitously shared simple generic methods we can also implement whole types. Matrix seems to be a good candidate"><meta property="og:type" content="article"><meta property="og:url" content="https://michalbrylka.github.io/posts/generic-math-matrix/"><meta property="og:image" content="https://michalbrylka.github.io/posts/generic-math-matrix/featured-image.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-05T00:00:00+01:00"><meta property="article:modified_time" content="2022-12-05T00:00:00+01:00"><meta property="og:site_name" content="Michał Bryłka | Devexcellence"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://michalbrylka.github.io/posts/generic-math-matrix/featured-image.png"><meta name=twitter:title content="Generic math extended example"><meta name=twitter:description content="Generic math feature from C# 11 brings us a lot of flexibility. Besides ubiquitously shared simple generic methods we can also implement whole types. Matrix seems to be a good candidate"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://michalbrylka.github.io/posts/generic-math-matrix/><link rel=prev href=https://michalbrylka.github.io/posts/static-interface-members/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Generic math extended example","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/michalbrylka.github.io\/posts\/generic-math-matrix\/"},"image":[{"@type":"ImageObject","url":"https:\/\/michalbrylka.github.io\/posts\/generic-math-matrix\/featured-image.png","width":800,"height":350}],"genre":"posts","keywords":"language, math, generics, csharp","wordcount":3668,"url":"https:\/\/michalbrylka.github.io\/posts\/generic-math-matrix\/","datePublished":"2022-12-05T00:00:00+01:00","dateModified":"2022-12-05T00:00:00+01:00","license":"\u0026copy; Copyright 2019-2022 Michał Bryłka","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Michał Bryłka"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Michał Bryłka | Devexcellence"><span class=header-title-pre><i class="fa-solid fa-code"></i></span>Devexcellence</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Michał Bryłka | Devexcellence"><span class=header-title-pre><i class="fa-solid fa-code"></i></span>Devexcellence</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Generic math extended example</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/MichalBrylka title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Michał Bryłka</a></span>&nbsp;<span class=post-category>included in <a href=/categories/programming/><i class="far fa-folder fa-fw" aria-hidden=true></i>programming</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-12-05>2022-12-05</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;3668 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;18 minutes&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/posts/generic-math-matrix/featured-image.png data-srcset="/posts/generic-math-matrix/featured-image.png, /posts/generic-math-matrix/featured-image.png 1.5x, /posts/generic-math-matrix/featured-image.png 2x" data-sizes=auto alt=/posts/generic-math-matrix/featured-image.png title=/posts/generic-math-matrix/featured-image.png></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#interfaces-and-operations>Interfaces and operations</a></li><li><a href=#checked-operators>Checked operators</a></li><li><a href=#identity-element-and-constants>Identity element and constants</a></li><li><a href=#conversions>Conversions</a></li><li><a href=#dedicated-functions>Dedicated functions</a></li><li><a href=#matrix-definition>Matrix definition</a><ul><li><a href=#structure>Structure</a></li><li><a href=#matrix-operations>Matrix operations</a></li><li><a href=#matrix-operators>Matrix operators</a></li><li><a href=#parsing>Parsing</a></li></ul></li><li><a href=#beyond-standard-number-types>Beyond standard number types</a></li><li><a href=#performance>Performance</a><ul><li><a href=#speed-of-development>Speed of development</a></li><li><a href=#runtime-performance>Runtime performance</a></li></ul></li><li><a href=#summary>Summary</a></li><li><a href=#bonus---physics>Bonus - physics</a></li><li><a href=#sources>Sources</a></li></ul></nav></div></div><div class=content id=content><p>C# 11.0 <a href=https://devblogs.microsoft.com/dotnet/preview-features-in-net-6-generic-math/ target=_blank rel="noopener noreffer">generic math</a> is very powerful extension to already capable generic types system present in C# since version 2.0. Besides <a href=https://michalbrylka.github.io/posts/static-interface-members/ title="Static Interface Members" rel>static interface members</a> there are couple of changes that make it easier to express math concepts in C#. Let&rsquo;s see what needed to change in order to add this neat feature.</p><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>This blog post participates in <a href=https://csadvent.christmas/ target=_blank rel="noopener noreffer">C# Advent Calendar 2022</a>. Expect around 50 awesome posts this month, with 2 being revealed every day. It&rsquo;s digital/C#-oriented counterpart of old <a href=https://en.wikipedia.org/wiki/Advent_calendar target=_blank rel="noopener noreffer">German tradition</a></div></div></div><h2 id=interfaces-and-operations>Interfaces and operations</h2><p>While generic math is C# 11 feature, there were some new additions in .NET framework itself. In order to facilitate appropriate abstraction, the following interfaces were introduced and numeric/built-in types subsequently started implementing them:</p><table><thead><tr><th>Interface</th><th>Description</th></tr></thead><tbody><tr><td><a href=https://learn.microsoft.com/en-us/dotnet/api/system.numerics.inumberbase-1 target=_blank rel="noopener noreffer">INumberBase</a></td><td>Base interface for all numbers</td></tr><tr><td><a href=https://learn.microsoft.com/en-us/dotnet/api/system.numerics.inumber-1 target=_blank rel="noopener noreffer">INumber</a></td><td>All members related to numbers. Extends INumberBase mostly for comparison operations</td></tr><tr><td>IParseable</td><td>Parse(string, IFormatProvider)</td></tr><tr><td>ISpanParseable</td><td>Parse(ReadOnlySpan, IFormatProvider)</td></tr><tr><td>IAdditionOperators</td><td>x + y</td></tr><tr><td>IBitwiseOperators</td><td>x & y, x | y, x ^ y and ~x</td></tr><tr><td>IComparisonOperators</td><td>x &lt; y, x > y, x &lt;= y, and x >= y</td></tr><tr><td>IDecrementOperators</td><td>&ndash;x and x&ndash;</td></tr><tr><td>IDivisionOperators</td><td>x / y</td></tr><tr><td>IEqualityOperators</td><td>x == y and x != y</td></tr><tr><td>IIncrementOperators</td><td>++x and x++</td></tr><tr><td>IModulusOperators</td><td>x % y</td></tr><tr><td>IMultiplyOperators</td><td>x * y</td></tr><tr><td>IShiftOperators</td><td>x &#171; y and x &#187; y</td></tr><tr><td>ISubtractionOperators</td><td>x - y</td></tr><tr><td>IUnaryNegationOperators</td><td>-x</td></tr><tr><td>IUnaryPlusOperators</td><td>+x</td></tr><tr><td>IAdditiveIdentity</td><td>(x + T.AdditiveIdentity) == x</td></tr><tr><td>IMinMaxValue</td><td>T.MinValue and T.MaxValue</td></tr><tr><td>IMultiplicativeIdentity</td><td>(x * T.MultiplicativeIdentity) == x</td></tr><tr><td>IBinaryFloatingPoint</td><td>Members common to binary floating-point types</td></tr><tr><td>IBinaryInteger</td><td>Members common to binary integer types</td></tr><tr><td>IBinaryNumber</td><td>Members common to binary number types</td></tr><tr><td>IFloatingPoint</td><td>Members common to floating-point types</td></tr><tr><td>INumber</td><td>Members common to number types</td></tr><tr><td>ISignedNumber</td><td>Members common to signed number types</td></tr><tr><td>IUnsignedNumber</td><td>Members common to unsigned number types</td></tr></tbody></table><p>List of all of them can be found on <a href="https://learn.microsoft.com/en-us/dotnet/api/system.numerics?view=net-7.0#interfaces" target=_blank rel="noopener noreffer">MSDN</a></p><h2 id=checked-operators>Checked operators</h2><p>In C# 11 it is now possible to specify operators as checked. Compiler will select appropriate version depending on context (Visual Studio will navigate to appropriate operator definition upon pressing <data id=id-1 data-raw></data>/&ldquo;Go to definition&rdquo;). Let&rsquo;s see that on example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>readonly</span> <span class=k>record</span> <span class=nc>struct</span> <span class=n>Point</span><span class=p>(</span><span class=kt>int</span> <span class=n>X</span><span class=p>,</span> <span class=kt>int</span> <span class=n>Y</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=n>Point</span> <span class=k>operator</span> <span class=k>checked</span> <span class=p>+(</span><span class=n>Point</span> <span class=n>left</span><span class=p>,</span> <span class=n>Point</span> <span class=n>right</span><span class=p>)</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>        <span class=k>checked</span><span class=p>(</span><span class=k>new</span><span class=p>(</span><span class=n>left</span><span class=p>.</span><span class=n>X</span> <span class=p>+</span> <span class=n>right</span><span class=p>.</span><span class=n>X</span><span class=p>,</span> <span class=n>left</span><span class=p>.</span><span class=n>Y</span> <span class=p>+</span> <span class=n>right</span><span class=p>.</span><span class=n>Y</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=n>Point</span> <span class=k>operator</span> <span class=p>+(</span><span class=n>Point</span> <span class=n>left</span><span class=p>,</span> <span class=n>Point</span> <span class=n>right</span><span class=p>)</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span><span class=p>(</span><span class=n>left</span><span class=p>.</span><span class=n>X</span> <span class=p>+</span> <span class=n>right</span><span class=p>.</span><span class=n>X</span><span class=p>,</span> <span class=n>left</span><span class=p>.</span><span class=n>Y</span> <span class=p>+</span> <span class=n>right</span><span class=p>.</span><span class=n>Y</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//usage</span>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>point</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Point</span><span class=p>(</span><span class=kt>int</span><span class=p>.</span><span class=n>MaxValue</span> <span class=p>-</span> <span class=m>1</span><span class=p>,</span> <span class=kt>int</span><span class=p>.</span><span class=n>MaxValue</span> <span class=p>-</span> <span class=m>2</span><span class=p>);</span> <span class=c1>//Point { X = 2147483646, Y = 2147483645 }</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>@unchecked</span> <span class=p>=</span> <span class=k>unchecked</span><span class=p>(</span><span class=n>point</span> <span class=p>+</span> <span class=n>point</span><span class=p>);</span> <span class=c1>//Point { X = -4, Y = -6 }</span>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>@checked</span> <span class=p>=</span> <span class=k>checked</span><span class=p>(</span><span class=n>point</span> <span class=p>+</span> <span class=n>point</span><span class=p>);</span> <span class=c1>//⚠️ throws System.OverflowException</span>
</span></span></code></pre></div><h2 id=identity-element-and-constants>Identity element and constants</h2><p>Every number type usually (always for C# numbers but that is not necessarily the case in math) has some identity elements for most popular operations (addition and multiplication). The following listing demonstrates them using generic guard as these constants are not publicly exposed</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>private</span> <span class=k>static</span> <span class=k>void</span> <span class=n>Constants</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;()</span> <span class=k>where</span> <span class=n>T</span> <span class=p>:</span> <span class=n>INumber</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>one</span> <span class=p>=</span> <span class=n>T</span><span class=p>.</span><span class=n>One</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>zero</span> <span class=p>=</span> <span class=n>T</span><span class=p>.</span><span class=n>Zero</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>additiveIdentity</span> <span class=p>=</span> <span class=n>T</span><span class=p>.</span><span class=n>AdditiveIdentity</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>multiplicativeIdentity</span> <span class=p>=</span> <span class=n>T</span><span class=p>.</span><span class=n>MultiplicativeIdentity</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=conversions>Conversions</h2><p>In order to be able to smoothly convert numbers from other number types, several methods were added:</p><ul><li><em>CreateChecked</em> - convert &ldquo;exactly&rdquo; or throw if number falls outside the representable range</li><li><em>CreateSaturating</em> - convert values saturating any values that fall outside the representable range</li><li><em>CreateTruncating</em> - convert values truncating any values that fall outside the representable range</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=c1>//specifying generic type is not needed, it&#39;s just here for clarity </span>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>b1</span> <span class=p>=</span> <span class=kt>byte</span><span class=p>.</span><span class=n>CreateSaturating</span><span class=p>&lt;</span><span class=kt>int</span><span class=p>&gt;(</span><span class=m>300</span><span class=p>);</span> <span class=c1>//255</span>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>b2</span> <span class=p>=</span> <span class=kt>byte</span><span class=p>.</span><span class=n>CreateTruncating</span><span class=p>(</span><span class=m>300</span><span class=p>);</span> <span class=c1>//44</span>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>b3</span> <span class=p>=</span> <span class=kt>byte</span><span class=p>.</span><span class=n>CreateChecked</span><span class=p>(</span><span class=m>300</span><span class=p>);</span> <span class=c1>//⚠️ Arithmetic operation resulted in an overflow.</span>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>b4</span> <span class=p>=</span> <span class=kt>byte</span><span class=p>.</span><span class=n>CreateChecked</span><span class=p>(</span><span class=m>3.14</span><span class=p>);</span> <span class=c1>//3</span>
</span></span></code></pre></div><h2 id=dedicated-functions>Dedicated functions</h2><p>New function were introduced to built-in types to facilitate typical operation that we perform with given number groups.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=c1>//Check if integer is power of two. Equivalent to BitOperations.IsPow2(1024) </span>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>isPow</span> <span class=p>=</span> <span class=kt>int</span><span class=p>.</span><span class=n>IsPow2</span><span class=p>(</span><span class=m>1024</span><span class=p>);</span> <span class=c1>// true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//Population count (number of bits set). Same as BitOperations.PopCount(15) - vectorized if possible </span>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>pop</span> <span class=p>=</span> <span class=kt>int</span><span class=p>.</span><span class=n>PopCount</span><span class=p>(</span><span class=m>15</span><span class=p>);</span> <span class=c1>// 4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//Cubic root of a specified number. Equivalent to MathF.Cbrt(x)</span>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>cbrt</span> <span class=p>=</span> <span class=kt>float</span><span class=p>.</span><span class=n>Cbrt</span><span class=p>(</span><span class=m>8.0f</span><span class=p>);</span> <span class=c1>// 2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//Sine of the specified angle (in radians). Equivalent to MathF.Sin(x)</span>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>sin</span> <span class=p>=</span> <span class=kt>float</span><span class=p>.</span><span class=n>Sin</span><span class=p>(</span><span class=kt>float</span><span class=p>.</span><span class=n>Pi</span> <span class=p>/</span> <span class=m>6.0f</span><span class=p>);</span> <span class=c1>//0.5</span>
</span></span></code></pre></div><p>For more functions see list for <a href="https://learn.microsoft.com/en-us/dotnet/api/system.numerics.ibinaryinteger-1?view=net-7.0#methods" target=_blank rel="noopener noreffer">integers</a> or <a href="https://learn.microsoft.com/en-us/dotnet/api/system.numerics.ifloatingpointieee754-1?view=net-7.0#methods" target=_blank rel="noopener noreffer">floating point numbers</a>. Other interesting function groups are:</p><ul><li><a href="https://learn.microsoft.com/en-us/dotnet/api/system.numerics.itrigonometricfunctions-1?view=net-7.0#methods" target=_blank rel="noopener noreffer">ITrigonometricFunctions</a></li><li><a href="https://learn.microsoft.com/en-us/dotnet/api/system.numerics.irootfunctions-1?view=net-7.0#methods" target=_blank rel="noopener noreffer">IRootFunctions</a></li><li><a href="https://learn.microsoft.com/en-us/dotnet/api/system.numerics.ipowerfunctions-1?view=net-7.0#methods" target=_blank rel="noopener noreffer">IPowerFunctions</a></li><li><a href="https://learn.microsoft.com/en-us/dotnet/api/system.numerics.ilogarithmicfunctions-1?view=net-7.0#methods" target=_blank rel="noopener noreffer">ILogarithmicFunctions</a></li></ul><h2 id=matrix-definition>Matrix definition</h2><p>We are now ready to propose a new type that will denote a generic matrix of number-like structures. Make sure to read a post about <a href=https://michalbrylka.github.io/posts/static-interface-members/ title="Static Interface Members" rel>static interface members</a> if that concept is still new to you.</p><h3 id=structure>Structure</h3><p>Let&rsquo;s start with simple definition. Just for fun we will be restricting our number generic parameter to <a href=https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/builtin-types/unmanaged-types target=_blank rel="noopener noreffer">unmanaged types</a>. This is not strictly needed for our example but it will allow for some tricks like faster array enumeration</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>public</span> <span class=k>partial</span> <span class=k>class</span> <span class=nc>Matrix</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span> <span class=c1>//for now we are not extending any interface</span>
</span></span><span class=line><span class=cl>       <span class=k>where</span> <span class=n>TNumber</span> <span class=p>:</span> <span class=n>unmanaged</span> <span class=c1>//needed for pointer &#34;magic&#34;</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>readonly</span> <span class=n>TNumber</span><span class=p>[,]</span> <span class=n>_data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>int</span> <span class=n>Rows</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>int</span> <span class=n>Columns</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>int</span> <span class=n>Size</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=n>TNumber</span> <span class=k>this</span><span class=p>[</span><span class=kt>int</span> <span class=n>iRow</span><span class=p>,</span> <span class=kt>int</span> <span class=n>iCol</span><span class=p>]</span> <span class=p>=&gt;</span> <span class=n>_data</span><span class=p>[</span><span class=n>iRow</span><span class=p>,</span> <span class=n>iCol</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=n>Matrix</span><span class=p>(</span><span class=n>TNumber</span><span class=p>[,]</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>_data</span> <span class=p>=</span> <span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>Rows</span> <span class=p>=</span> <span class=n>data</span><span class=p>.</span><span class=n>GetLength</span><span class=p>(</span><span class=m>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Columns</span> <span class=p>=</span> <span class=n>data</span><span class=p>.</span><span class=n>GetLength</span><span class=p>(</span><span class=m>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Size</span> <span class=p>=</span> <span class=n>Rows</span> <span class=p>*</span> <span class=n>Columns</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>     
</span></span><span class=line><span class=cl>    <span class=c1>//optionally we&#39;d like to be able to create Matrix using 1-D array with certain number of columns </span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>unsafe</span> <span class=n>Matrix</span><span class=p>(</span><span class=n>TNumber</span><span class=p>[]</span> <span class=n>data</span><span class=p>,</span> <span class=kt>int</span> <span class=n>columns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>data2d</span> <span class=p>=</span> <span class=k>new</span> <span class=n>TNumber</span><span class=p>[</span><span class=n>data</span><span class=p>.</span><span class=n>Length</span> <span class=p>/</span> <span class=n>columns</span><span class=p>,</span> <span class=n>columns</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>fixed</span> <span class=p>(</span><span class=n>TNumber</span><span class=p>*</span> <span class=n>pSource</span> <span class=p>=</span> <span class=n>data</span><span class=p>,</span> <span class=n>pTarget</span> <span class=p>=</span> <span class=n>data2d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>data</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>                <span class=n>pTarget</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>pSource</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>_data</span> <span class=p>=</span> <span class=n>data2d</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>Rows</span> <span class=p>=</span> <span class=n>data2d</span><span class=p>.</span><span class=n>GetLength</span><span class=p>(</span><span class=m>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Columns</span> <span class=p>=</span> <span class=n>data2d</span><span class=p>.</span><span class=n>GetLength</span><span class=p>(</span><span class=m>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=matrix-operations>Matrix operations</h3><p>While this class already is able to store some data, we would not be able to do anything meaningful with it. Let&rsquo;s add our first math operation - addition. Since that operation uses only addition and needs to be seeded with zero (additive identity) we could modify our generic guard to:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>class</span> <span class=nc>Matrix</span>
</span></span><span class=line><span class=cl>    <span class=k>where</span> <span class=n>TNumber</span> <span class=p>:</span> <span class=n>unmanaged</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=n>IAdditionOperators</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>,</span> <span class=n>TNumber</span><span class=p>,</span> <span class=n>TNumber</span><span class=p>&gt;,</span>
</span></span><span class=line><span class=cl>        <span class=n>IAdditiveIdentity</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>,</span> <span class=n>TNumber</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=cm>/*...*/</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>unsafe</span> <span class=n>TNumber</span> <span class=n>Sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=kt>var</span> <span class=n>result</span> <span class=p>=</span> <span class=n>TNumber</span><span class=p>.</span><span class=n>AdditiveIdentity</span><span class=p>;</span>
</span></span><span class=line><span class=cl>       <span class=k>fixed</span> <span class=p>(</span><span class=n>TNumber</span><span class=p>*</span> <span class=n>pData</span> <span class=p>=</span> <span class=n>_data</span><span class=p>)</span> <span class=c1>//use pointers to be able to iterate array faster </span>
</span></span><span class=line><span class=cl>       <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=kt>var</span> <span class=n>p</span> <span class=p>=</span> <span class=n>pData</span><span class=p>;</span>
</span></span><span class=line><span class=cl>           <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>Size</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>               <span class=n>result</span> <span class=p>+=</span> <span class=p>*</span><span class=n>p</span><span class=p>++;</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>    
</span></span><span class=line><span class=cl>       <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>but we would be better off when that guard would be changed to</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>public</span> <span class=k>partial</span> <span class=k>class</span> <span class=nc>Matrix</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=k>where</span> <span class=n>TNumber</span> <span class=p>:</span> <span class=n>unmanaged</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=c1>//it is just necessary to mark number type appropriately to be able to use it in generic contexts</span>
</span></span><span class=line><span class=cl>        <span class=n>INumberBase</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span> 
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/*...*/</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>unsafe</span> <span class=n>TNumber</span> <span class=n>Sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//&#34;Zero&#34; also looks more natural in that context as opposed to &#34;AdditiveIdentity&#34;</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>result</span> <span class=p>=</span> <span class=n>TNumber</span><span class=p>.</span><span class=n>Zero</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>        <span class=k>fixed</span> <span class=p>(</span><span class=n>TNumber</span><span class=p>*</span> <span class=n>pData</span> <span class=p>=</span> <span class=n>_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>p</span> <span class=p>=</span> <span class=n>pData</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>Size</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span> <span class=p>+=</span> <span class=p>*</span><span class=n>p</span><span class=p>++;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Summation is obviously useful but it&rsquo;s also trivial in it&rsquo;s form. For instance let&rsquo;s consider C# whole number types. Like in math, <a href=https://en.wikipedia.org/wiki/Natural_number target=_blank rel="noopener noreffer">natural</a> and <a href=https://en.wikipedia.org/wiki/Integer target=_blank rel="noopener noreffer">integer</a> numbers are <a href=https://en.wikipedia.org/wiki/Closure_%28mathematics%29 target=_blank rel="noopener noreffer">closed</a> under addition. When you consider other operations on these numbers, say division, this is no longer the case. While we could calculate an average of integers in C# as follows</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kt>var</span> <span class=n>intArray</span> <span class=p>=</span> <span class=k>new</span><span class=p>[]</span> <span class=p>{</span> <span class=m>1</span><span class=p>,</span> <span class=m>2</span><span class=p>,</span> <span class=m>4</span> <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>avg</span> <span class=p>=</span> <span class=n>intArray</span><span class=p>.</span><span class=n>Sum</span><span class=p>()</span> <span class=p>/</span> <span class=n>intArray</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span> <span class=c1>//2</span>
</span></span></code></pre></div><p>it would be more convenient to convert result and intermediate operations to floating point numbers. Even LINQ function does that:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kt>var</span> <span class=n>avgLinq</span> <span class=p>=</span> <span class=n>intArray</span><span class=p>.</span><span class=n>Average</span><span class=p>();</span> <span class=c1>//2.3333333333333335</span>
</span></span></code></pre></div><p>This conversion will do the trick for our matrix:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>public</span> <span class=k>unsafe</span> <span class=n>TResult</span> <span class=n>Sum</span><span class=p>&lt;</span><span class=n>TResult</span><span class=p>&gt;()</span> <span class=k>where</span> <span class=n>TResult</span> <span class=p>:</span> <span class=n>INumber</span><span class=p>&lt;</span><span class=n>TResult</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>result</span> <span class=p>=</span> <span class=n>TResult</span><span class=p>.</span><span class=n>Zero</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>fixed</span> <span class=p>(</span><span class=n>TNumber</span><span class=p>*</span> <span class=n>pData</span> <span class=p>=</span> <span class=n>_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>p</span> <span class=p>=</span> <span class=n>pData</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>Size</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=p>+=</span> <span class=n>TResult</span><span class=p>.</span><span class=n>CreateChecked</span><span class=p>(*</span><span class=n>p</span><span class=p>++);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// now Average can use Sum&lt;TResult&gt;</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=n>TResult</span> <span class=n>Average</span><span class=p>&lt;</span><span class=n>TResult</span><span class=p>&gt;()</span> <span class=k>where</span> <span class=n>TResult</span> <span class=p>:</span> <span class=n>INumber</span><span class=p>&lt;</span><span class=n>TResult</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>TResult</span> <span class=n>sum</span> <span class=p>=</span> <span class=n>Sum</span><span class=p>&lt;</span><span class=n>TResult</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sum</span> <span class=p>/</span> <span class=n>TResult</span><span class=p>.</span><span class=n>CreateChecked</span><span class=p>(</span><span class=n>Size</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>No matrix is complete without <a href=https://en.wikipedia.org/wiki/Determinant target=_blank rel="noopener noreffer">Determinant</a> function. While there are dozens of algorithms to do that, I&rsquo;ll use a plain decomposition approach due to it&rsquo;s simplicity</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>public</span> <span class=n>TNumber</span> <span class=n>Determinant</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>Rows</span> <span class=p>!=</span> <span class=n>Columns</span><span class=p>)</span> <span class=k>throw</span> <span class=k>new</span><span class=p>(</span><span class=s>&#34;Determinant of a non-square matrix doesn&#39;t exist&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>det</span> <span class=p>=</span> <span class=n>TNumber</span><span class=p>.</span><span class=n>Zero</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>Rows</span> <span class=p>==</span> <span class=m>1</span><span class=p>)</span> <span class=k>return</span> <span class=k>this</span><span class=p>[</span><span class=m>0</span><span class=p>,</span> <span class=m>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>Rows</span> <span class=p>==</span> <span class=m>2</span><span class=p>)</span> <span class=k>return</span> <span class=k>this</span><span class=p>[</span><span class=m>0</span><span class=p>,</span> <span class=m>0</span><span class=p>]</span> <span class=p>*</span> <span class=k>this</span><span class=p>[</span><span class=m>1</span><span class=p>,</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=k>this</span><span class=p>[</span><span class=m>0</span><span class=p>,</span> <span class=m>1</span><span class=p>]</span> <span class=p>*</span> <span class=k>this</span><span class=p>[</span><span class=m>1</span><span class=p>,</span> <span class=m>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>j</span> <span class=p>&lt;</span> <span class=n>Columns</span><span class=p>;</span> <span class=n>j</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>TNumber</span> <span class=n>reduced</span> <span class=p>=</span> <span class=k>this</span><span class=p>[</span><span class=m>0</span><span class=p>,</span> <span class=n>j</span><span class=p>]</span> <span class=p>*</span> <span class=n>Minor</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=n>j</span><span class=p>).</span><span class=n>Determinant</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>j</span> <span class=p>%</span> <span class=m>2</span> <span class=p>==</span> <span class=m>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>reduced</span> <span class=p>=</span> <span class=p>-</span><span class=n>reduced</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>det</span> <span class=p>+=</span> <span class=n>reduced</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>det</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=n>Matrix</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span> <span class=n>Minor</span><span class=p>(</span><span class=kt>int</span> <span class=n>iRow</span><span class=p>,</span> <span class=kt>int</span> <span class=n>iCol</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>minor</span> <span class=p>=</span> <span class=k>new</span> <span class=n>TNumber</span><span class=p>[</span><span class=n>Rows</span> <span class=p>-</span> <span class=m>1</span><span class=p>,</span> <span class=n>Columns</span> <span class=p>-</span> <span class=m>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>m</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>Rows</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=p>==</span> <span class=n>iRow</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>n</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>j</span> <span class=p>&lt;</span> <span class=n>Columns</span><span class=p>;</span> <span class=n>j</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>j</span> <span class=p>==</span> <span class=n>iCol</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>minor</span><span class=p>[</span><span class=n>m</span><span class=p>,</span> <span class=n>n</span><span class=p>]</span> <span class=p>=</span> <span class=k>this</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=n>n</span><span class=p>++;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>m</span><span class=p>++;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span><span class=p>(</span><span class=n>minor</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Similarly it might be useful to obtain largest and smallest element in matrix. Since that requires some comparisons, let&rsquo;s add <code>IComparisonOperators&lt;TNumber, TNumber, bool></code> interface to our generic guard for <code>TNumber</code>. Doing so enables us to then use comparison operators. We will however lose (as a consequence) the ability of using types that do not possess relational ordering - <a href="https://learn.microsoft.com/en-us/dotnet/api/system.numerics.complex?view=net-7.0" target=_blank rel="noopener noreffer">Complex</a> type being most notable here<div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>Using <code>IComparisonOperators&lt;TNumber, TNumber, bool></code> is somewhat limiting. It&rsquo;s probably more important to be able to use final matrix with types like Complex especially if Min/Max operation could be added using different approach. So final design of matrix might reflect that notion</div></div></div></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>public</span> <span class=k>unsafe</span> <span class=n>TNumber</span> <span class=n>Min</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>Size</span> <span class=p>==</span> <span class=m>0</span><span class=p>)</span> <span class=k>throw</span> <span class=k>new</span><span class=p>(</span><span class=s>&#34;Matrix is empty&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>TNumber</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>fixed</span> <span class=p>(</span><span class=n>TNumber</span><span class=p>*</span> <span class=n>pData</span> <span class=p>=</span> <span class=n>_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>p</span> <span class=p>=</span> <span class=n>pData</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=p>=</span> <span class=p>*</span><span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>Size</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=p>=</span> <span class=n>Min</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=p>*</span><span class=n>p</span><span class=p>++);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>static</span> <span class=n>TNumber</span> <span class=n>Min</span><span class=p>(</span><span class=n>TNumber</span> <span class=n>x</span><span class=p>,</span> <span class=n>TNumber</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=n>x</span> <span class=p>!=</span> <span class=n>y</span><span class=p>)</span> <span class=p>&amp;&amp;</span> <span class=p>!</span><span class=n>TNumber</span><span class=p>.</span><span class=n>IsNaN</span><span class=p>(</span><span class=n>x</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>x</span> <span class=p>&lt;</span> <span class=n>y</span> <span class=p>?</span> <span class=n>x</span> <span class=p>:</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>TNumber</span><span class=p>.</span><span class=n>IsNegative</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=p>?</span> <span class=n>x</span> <span class=p>:</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>unsafe</span> <span class=n>TNumber</span> <span class=n>Max</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>Size</span> <span class=p>==</span> <span class=m>0</span><span class=p>)</span> <span class=k>throw</span> <span class=k>new</span><span class=p>(</span><span class=s>&#34;Matrix is empty&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>TNumber</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>fixed</span> <span class=p>(</span><span class=n>TNumber</span><span class=p>*</span> <span class=n>pData</span> <span class=p>=</span> <span class=n>_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>p</span> <span class=p>=</span> <span class=n>pData</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=p>=</span> <span class=p>*</span><span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>Size</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=p>=</span> <span class=n>Max</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=p>*</span><span class=n>p</span><span class=p>++);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>static</span> <span class=n>TNumber</span> <span class=n>Max</span><span class=p>(</span><span class=n>TNumber</span> <span class=n>x</span><span class=p>,</span> <span class=n>TNumber</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>x</span> <span class=p>!=</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>TNumber</span><span class=p>.</span><span class=n>IsNaN</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=p>?</span> <span class=n>x</span> <span class=p>:</span> <span class=n>y</span> <span class=p>&lt;</span> <span class=n>x</span> <span class=p>?</span> <span class=n>x</span> <span class=p>:</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>TNumber</span><span class=p>.</span><span class=n>IsNegative</span><span class=p>(</span><span class=n>y</span><span class=p>)</span> <span class=p>?</span> <span class=n>x</span> <span class=p>:</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=matrix-operators>Matrix operators</h3><p>Have a look at the following operators (code example might need expanding):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=c1>//add 2 matrices</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>unsafe</span> <span class=k>static</span> <span class=n>Matrix</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span> <span class=k>operator</span> <span class=p>+(</span><span class=n>Matrix</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span> <span class=n>left</span><span class=p>,</span> <span class=n>Matrix</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span> <span class=n>right</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>left</span><span class=p>.</span><span class=n>Rows</span> <span class=p>!=</span> <span class=n>right</span><span class=p>.</span><span class=n>Rows</span> <span class=p>||</span> <span class=n>left</span><span class=p>.</span><span class=n>Columns</span> <span class=p>!=</span> <span class=n>right</span><span class=p>.</span><span class=n>Columns</span><span class=p>)</span> <span class=k>throw</span> <span class=k>new</span><span class=p>(</span><span class=s>&#34;Sum of 2 matrices is only possible when they are same size&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>data</span> <span class=p>=</span> <span class=k>new</span> <span class=n>TNumber</span><span class=p>[</span><span class=n>left</span><span class=p>.</span><span class=n>Rows</span><span class=p>,</span> <span class=n>left</span><span class=p>.</span><span class=n>Columns</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>size</span> <span class=p>=</span> <span class=n>left</span><span class=p>.</span><span class=n>Rows</span> <span class=p>*</span> <span class=n>left</span><span class=p>.</span><span class=n>Columns</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fixed</span> <span class=p>(</span><span class=n>TNumber</span><span class=p>*</span> <span class=n>lSource</span> <span class=p>=</span> <span class=n>left</span><span class=p>.</span><span class=n>_data</span><span class=p>,</span> <span class=n>rSource</span> <span class=p>=</span> <span class=n>right</span><span class=p>.</span><span class=n>_data</span><span class=p>,</span> <span class=n>target</span> <span class=p>=</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=n>target</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>lSource</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>+</span> <span class=n>rSource</span><span class=p>[</span><span class=n>i</span><span class=p>];</span> <span class=c1>//checked operator version would differ only in this line</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>Matrix</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;(</span><span class=n>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//right-side operator for adding single number element-wise</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>unsafe</span> <span class=k>static</span> <span class=n>Matrix</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span> <span class=k>operator</span> <span class=p>+(</span><span class=n>Matrix</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span> <span class=n>left</span><span class=p>,</span> <span class=n>TNumber</span> <span class=n>right</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>data</span> <span class=p>=</span> <span class=k>new</span> <span class=n>TNumber</span><span class=p>[</span><span class=n>left</span><span class=p>.</span><span class=n>Rows</span><span class=p>,</span> <span class=n>left</span><span class=p>.</span><span class=n>Columns</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>size</span> <span class=p>=</span> <span class=n>left</span><span class=p>.</span><span class=n>Rows</span> <span class=p>*</span> <span class=n>left</span><span class=p>.</span><span class=n>Columns</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fixed</span> <span class=p>(</span><span class=n>TNumber</span><span class=p>*</span> <span class=n>lSource</span> <span class=p>=</span> <span class=n>left</span><span class=p>.</span><span class=n>_data</span><span class=p>,</span> <span class=n>target</span> <span class=p>=</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=n>target</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>lSource</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>+</span> <span class=n>right</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>Matrix</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;(</span><span class=n>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// Multiplication. More efficient function might be chosen for production code. </span>
</span></span><span class=line><span class=cl><span class=c1>// This is just to illustrate this operator</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>static</span> <span class=n>Matrix</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span> <span class=k>operator</span> <span class=p>*(</span><span class=n>Matrix</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span> <span class=n>a</span><span class=p>,</span> <span class=n>Matrix</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span> <span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>rowsA</span> <span class=p>=</span> <span class=n>a</span><span class=p>.</span><span class=n>Rows</span><span class=p>,</span> <span class=n>colsA</span> <span class=p>=</span> <span class=n>a</span><span class=p>.</span><span class=n>Columns</span><span class=p>,</span> <span class=n>rowsB</span> <span class=p>=</span> <span class=n>b</span><span class=p>.</span><span class=n>Rows</span><span class=p>,</span> <span class=n>colsB</span> <span class=p>=</span> <span class=n>b</span><span class=p>.</span><span class=n>Columns</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>colsA</span> <span class=p>!=</span> <span class=n>rowsB</span><span class=p>)</span> <span class=k>throw</span> <span class=k>new</span><span class=p>(</span><span class=s>&#34;Matrixes can&#39;t be multiplied&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>data</span> <span class=p>=</span> <span class=k>new</span> <span class=n>TNumber</span><span class=p>[</span><span class=n>rowsA</span><span class=p>,</span> <span class=n>colsB</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>rowsA</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>j</span> <span class=p>&lt;</span> <span class=n>colsB</span><span class=p>;</span> <span class=n>j</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>temp</span> <span class=p>=</span> <span class=n>TNumber</span><span class=p>.</span><span class=n>Zero</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>k</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>k</span> <span class=p>&lt;</span> <span class=n>colsA</span><span class=p>;</span> <span class=n>k</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>                <span class=n>temp</span> <span class=p>+=</span> <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>k</span><span class=p>]</span> <span class=p>*</span> <span class=n>b</span><span class=p>[</span><span class=n>k</span><span class=p>,</span> <span class=n>j</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>]</span> <span class=p>=</span> <span class=n>temp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>Matrix</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;(</span><span class=n>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=parsing>Parsing</h3><p>No math structure is complete without parsing and formatting routines. We would like to support multiple matrix definition formats like:</p><ul><li>Matlab: <code>[1,2,3 ; 4,5,6 ; 7,8,9]</code></li><li>Mathematica: <code>{{1,2,3},{4,5,6},{7,8,9}}</code></li><li>natural notation:
<data id=id-2 data-raw></data></li></ul><p>The code below might do the trick (full code is linked at the end of current article):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=cs>/// &lt;summary&gt;Parsing and formatting operation for matrices&lt;/summary&gt;</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>interface</span> <span class=nc>IMatrixTextFormat</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cs>/// &lt;summary&gt;</span>
</span></span><span class=line><span class=cl>    <span class=cs>/// Parse matrix from text buffer </span>
</span></span><span class=line><span class=cl>    <span class=cs>/// &lt;/summary&gt;    </span>
</span></span><span class=line><span class=cl>    <span class=n>Matrix</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span> <span class=n>Parse</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;(</span><span class=n>ReadOnlySpan</span><span class=p>&lt;</span><span class=kt>char</span><span class=p>&gt;</span> <span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>where</span> <span class=n>TNumber</span> <span class=p>:</span> <span class=n>unmanaged</span><span class=p>,</span> <span class=n>IComparisonOperators</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>,</span> <span class=n>TNumber</span><span class=p>,</span> <span class=kt>bool</span><span class=p>&gt;,</span> <span class=n>INumberBase</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cs>/// &lt;summary&gt;</span>
</span></span><span class=line><span class=cl>    <span class=cs>/// Attempt to format current matrix in provided text buffer</span>
</span></span><span class=line><span class=cl>    <span class=cs>/// &lt;/summary&gt;        </span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=n>TryFormat</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;(</span><span class=n>Matrix</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span> <span class=n>matrix</span><span class=p>,</span> <span class=n>Span</span><span class=p>&lt;</span><span class=kt>char</span><span class=p>&gt;</span> <span class=n>destination</span><span class=p>,</span> <span class=k>out</span> <span class=kt>int</span> <span class=n>charsWritten</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                            <span class=n>ReadOnlySpan</span><span class=p>&lt;</span><span class=kt>char</span><span class=p>&gt;</span> <span class=n>format</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>where</span> <span class=n>TNumber</span> <span class=p>:</span> <span class=n>unmanaged</span><span class=p>,</span> <span class=n>IComparisonOperators</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>,</span> <span class=n>TNumber</span><span class=p>,</span> <span class=kt>bool</span><span class=p>&gt;,</span> <span class=n>INumberBase</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>readonly</span> <span class=k>struct</span> <span class=nc>StandardFormat</span> <span class=p>:</span> <span class=n>IMatrixTextFormat</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>readonly</span> <span class=n>IFormatProvider</span> <span class=n>_underlyingProvider</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>readonly</span> <span class=n>NumberStyles</span><span class=p>?</span> <span class=n>_numberStyles</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>readonly</span> <span class=kt>char</span> <span class=n>_elementSeparator</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>static</span> <span class=k>readonly</span> <span class=kt>char</span><span class=p>[]</span> <span class=n>_rowSeparators</span> <span class=p>=</span> <span class=n>Environment</span><span class=p>.</span><span class=n>NewLine</span><span class=p>.</span><span class=n>ToCharArray</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=n>StandardFormat</span><span class=p>()</span> <span class=p>:</span> <span class=k>this</span><span class=p>(</span><span class=n>CultureInfo</span><span class=p>.</span><span class=n>InvariantCulture</span><span class=p>)</span> <span class=p>{</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=n>StandardFormat</span><span class=p>(</span><span class=n>IFormatProvider</span><span class=p>?</span> <span class=n>underlyingProvider</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                          <span class=n>NumberStyles</span> <span class=n>numberStyles</span> <span class=p>=</span> <span class=n>NumberStyles</span><span class=p>.</span><span class=n>Any</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>_numberStyles</span> <span class=p>=</span> <span class=n>numberStyles</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>_underlyingProvider</span> <span class=p>=</span> <span class=n>underlyingProvider</span> <span class=p>??</span> <span class=n>CultureInfo</span><span class=p>.</span><span class=n>InvariantCulture</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=n>_underlyingProvider</span><span class=p>,</span> <span class=n>_elementSeparator</span><span class=p>)</span> <span class=p>=</span> <span class=n>GetParameters</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=p>(</span><span class=n>IFormatProvider</span> <span class=n>Provider</span><span class=p>,</span> <span class=kt>char</span> <span class=n>ElementSeparator</span><span class=p>)</span> <span class=n>GetParameters</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>provider</span> <span class=p>=</span> <span class=n>_underlyingProvider</span> <span class=p>??</span> <span class=n>CultureInfo</span><span class=p>.</span><span class=n>InvariantCulture</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>char</span> <span class=n>elementSeparator</span> <span class=p>=</span> <span class=n>_elementSeparator</span> <span class=p>!=</span> <span class=sc>&#39;\0&#39;</span>
</span></span><span class=line><span class=cl>            <span class=p>?</span> <span class=n>_elementSeparator</span>
</span></span><span class=line><span class=cl>            <span class=p>:</span> <span class=p>(</span><span class=n>provider</span> <span class=k>is</span> <span class=n>CultureInfo</span> <span class=n>ci</span> <span class=p>?</span> <span class=n>ci</span><span class=p>.</span><span class=n>TextInfo</span><span class=p>.</span><span class=n>ListSeparator</span><span class=p>.</span><span class=n>Trim</span><span class=p>().</span><span class=n>Single</span><span class=p>()</span> <span class=p>:</span> <span class=sc>&#39;;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=n>provider</span><span class=p>,</span> <span class=n>elementSeparator</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=n>Matrix</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span> <span class=n>Parse</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;(</span><span class=n>ReadOnlySpan</span><span class=p>&lt;</span><span class=kt>char</span><span class=p>&gt;</span> <span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>where</span> <span class=n>TNumber</span> <span class=p>:</span> <span class=n>unmanaged</span><span class=p>,</span> <span class=n>IComparisonOperators</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>,</span> <span class=n>TNumber</span><span class=p>,</span> <span class=kt>bool</span><span class=p>&gt;,</span> <span class=n>INumberBase</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=p>(</span><span class=n>provider</span><span class=p>,</span> <span class=n>elementSeparator</span><span class=p>)</span> <span class=p>=</span> <span class=n>GetParameters</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>numberStyles</span> <span class=p>=</span> <span class=n>_numberStyles</span> <span class=p>??</span> <span class=n>NumberStyles</span><span class=p>.</span><span class=n>Any</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>rowsEnumerator</span> <span class=p>=</span> <span class=n>s</span><span class=p>.</span><span class=n>Split</span><span class=p>(</span><span class=n>_rowSeparators</span><span class=p>,</span> <span class=k>true</span><span class=p>).</span><span class=n>GetEnumerator</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(!</span><span class=n>rowsEnumerator</span><span class=p>.</span><span class=n>MoveNext</span><span class=p>())</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>FormatException</span><span class=p>(</span><span class=s>&#34;Non empty text is expected&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>firstRow</span> <span class=p>=</span> <span class=n>rowsEnumerator</span><span class=p>.</span><span class=n>Current</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>numCols</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>using</span> <span class=nn>var</span> <span class=n>buffer</span> <span class=p>=</span> <span class=k>new</span> <span class=n>ValueSequenceBuilder</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;(</span><span class=k>stackalloc</span> <span class=n>TNumber</span><span class=p>[</span><span class=m>32</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=k>foreach</span> <span class=p>(</span><span class=kt>var</span> <span class=n>col</span> <span class=k>in</span> <span class=n>firstRow</span><span class=p>.</span><span class=n>Split</span><span class=p>(</span><span class=n>elementSeparator</span><span class=p>,</span> <span class=k>true</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>col</span><span class=p>.</span><span class=n>IsEmpty</span><span class=p>)</span> <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>buffer</span><span class=p>.</span><span class=n>Append</span><span class=p>(</span><span class=n>TNumber</span><span class=p>.</span><span class=n>Parse</span><span class=p>(</span><span class=n>col</span><span class=p>,</span> <span class=n>numberStyles</span><span class=p>,</span> <span class=n>provider</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=n>numCols</span><span class=p>++;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>numRows</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>rowsEnumerator</span><span class=p>.</span><span class=n>MoveNext</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>row</span> <span class=p>=</span> <span class=n>rowsEnumerator</span><span class=p>.</span><span class=n>Current</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>row</span><span class=p>.</span><span class=n>IsEmpty</span><span class=p>)</span> <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>foreach</span> <span class=p>(</span><span class=kt>var</span> <span class=n>col</span> <span class=k>in</span> <span class=n>row</span><span class=p>.</span><span class=n>Split</span><span class=p>(</span><span class=n>elementSeparator</span><span class=p>,</span> <span class=k>true</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>col</span><span class=p>.</span><span class=n>IsEmpty</span><span class=p>)</span> <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>buffer</span><span class=p>.</span><span class=n>Append</span><span class=p>(</span><span class=n>TNumber</span><span class=p>.</span><span class=n>Parse</span><span class=p>(</span><span class=n>col</span><span class=p>,</span> <span class=n>numberStyles</span><span class=p>,</span> <span class=n>provider</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>numRows</span><span class=p>++;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>matrix</span> <span class=p>=</span> <span class=k>new</span> <span class=n>TNumber</span><span class=p>[</span><span class=n>numRows</span><span class=p>,</span> <span class=n>numCols</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>buffer</span><span class=p>.</span><span class=n>AsSpan</span><span class=p>().</span><span class=n>CopyTo2D</span><span class=p>(</span><span class=n>matrix</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>Matrix</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;(</span><span class=n>matrix</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>bool</span> <span class=n>TryFormat</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;(</span><span class=n>Matrix</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span> <span class=n>matrix</span><span class=p>,</span> <span class=n>Span</span><span class=p>&lt;</span><span class=kt>char</span><span class=p>&gt;</span> <span class=n>destination</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                                   <span class=k>out</span> <span class=kt>int</span> <span class=n>charsWritten</span><span class=p>,</span> <span class=n>ReadOnlySpan</span><span class=p>&lt;</span><span class=kt>char</span><span class=p>&gt;</span> <span class=n>format</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>where</span> <span class=n>TNumber</span> <span class=p>:</span> <span class=n>unmanaged</span><span class=p>,</span> <span class=n>IComparisonOperators</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>,</span> <span class=n>TNumber</span><span class=p>,</span> <span class=kt>bool</span><span class=p>&gt;,</span> <span class=n>INumberBase</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=p>(</span><span class=n>provider</span><span class=p>,</span> <span class=n>elementSeparator</span><span class=p>)</span> <span class=p>=</span> <span class=n>GetParameters</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>newLine</span> <span class=p>=</span> <span class=n>_rowSeparators</span><span class=p>.</span><span class=n>AsSpan</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>newLineLen</span> <span class=p>=</span> <span class=n>newLine</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>charsWrittenSoFar</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>matrix</span><span class=p>.</span><span class=n>Rows</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>j</span> <span class=p>&lt;</span> <span class=n>matrix</span><span class=p>.</span><span class=n>Columns</span><span class=p>;</span> <span class=n>j</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>bool</span> <span class=n>tryFormatSucceeded</span> <span class=p>=</span> <span class=n>matrix</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>].</span><span class=n>TryFormat</span><span class=p>(</span><span class=n>destination</span><span class=p>[</span><span class=n>charsWrittenSoFar</span><span class=p>..],</span> 
</span></span><span class=line><span class=cl>                    <span class=k>out</span> <span class=kt>var</span> <span class=n>tryFormatCharsWritten</span><span class=p>,</span> <span class=n>format</span><span class=p>,</span> <span class=n>provider</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>charsWrittenSoFar</span> <span class=p>+=</span> <span class=n>tryFormatCharsWritten</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(!</span><span class=n>tryFormatSucceeded</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>charsWritten</span> <span class=p>=</span> <span class=n>charsWrittenSoFar</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>j</span> <span class=p>&lt;</span> <span class=n>matrix</span><span class=p>.</span><span class=n>Columns</span> <span class=p>-</span> <span class=m>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=n>destination</span><span class=p>.</span><span class=n>Length</span> <span class=p>&lt;</span> <span class=n>charsWrittenSoFar</span> <span class=p>+</span> <span class=m>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>charsWritten</span> <span class=p>=</span> <span class=n>charsWrittenSoFar</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=n>destination</span><span class=p>[</span><span class=n>charsWrittenSoFar</span><span class=p>++]</span> <span class=p>=</span> <span class=n>elementSeparator</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>destination</span><span class=p>[</span><span class=n>charsWrittenSoFar</span><span class=p>++]</span> <span class=p>=</span> <span class=sc>&#39; &#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=p>&lt;</span> <span class=n>matrix</span><span class=p>.</span><span class=n>Rows</span> <span class=p>-</span> <span class=m>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>destination</span><span class=p>.</span><span class=n>Length</span> <span class=p>&lt;</span> <span class=n>charsWrittenSoFar</span> <span class=p>+</span> <span class=n>newLineLen</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>charsWritten</span> <span class=p>=</span> <span class=n>charsWrittenSoFar</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>newLine</span><span class=p>.</span><span class=n>CopyTo</span><span class=p>(</span><span class=n>destination</span><span class=p>[</span><span class=n>charsWrittenSoFar</span><span class=p>..]);</span>
</span></span><span class=line><span class=cl>                <span class=n>charsWrittenSoFar</span> <span class=p>+=</span> <span class=n>newLineLen</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>charsWritten</span> <span class=p>=</span> <span class=n>charsWrittenSoFar</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=beyond-standard-number-types>Beyond standard number types</h2><p>So far we&rsquo;ve assumed (quite correctly) that only types that implement <code>INumberBase&lt;TNumber></code> interface are built‑in system number types. Let&rsquo;s quickly implement a rational/fraction structure and see how it can be used in our matrix. For brevity I&rsquo;m only providing/implementing formatting routines (stay tuned for more functionality):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>readonly</span> <span class=k>record</span> <span class=nc>struct</span> <span class=n>Rational</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;(</span><span class=n>TNumber</span> <span class=n>Numerator</span><span class=p>,</span> <span class=n>TNumber</span> <span class=n>Denominator</span><span class=p>)</span> <span class=p>:</span> <span class=n>IEquatable</span><span class=p>&lt;</span><span class=n>Rational</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;&gt;,</span> <span class=n>IComparisonOperators</span><span class=p>&lt;</span><span class=n>Rational</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;,</span> <span class=n>Rational</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;,</span> <span class=kt>bool</span><span class=p>&gt;,</span>
</span></span><span class=line><span class=cl>     <span class=n>INumberBase</span><span class=p>&lt;</span><span class=n>Rational</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;&gt;</span>
</span></span><span class=line><span class=cl>     <span class=k>where</span> <span class=n>TNumber</span> <span class=p>:</span> <span class=n>IBinaryInteger</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span> <span class=c1>//make sense to allow only integers for numerator and denominator</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=n>Rational</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span> <span class=n>Zero</span> <span class=p>=&gt;</span> <span class=k>new</span><span class=p>(</span><span class=n>TNumber</span><span class=p>.</span><span class=n>Zero</span><span class=p>,</span> <span class=n>TNumber</span><span class=p>.</span><span class=n>One</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=n>Rational</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span> <span class=n>One</span> <span class=p>=&gt;</span> <span class=k>new</span><span class=p>(</span><span class=n>TNumber</span><span class=p>.</span><span class=n>One</span><span class=p>,</span> <span class=n>TNumber</span><span class=p>.</span><span class=n>One</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=n>Rational</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span> <span class=n>AdditiveIdentity</span> <span class=p>=&gt;</span> <span class=n>Zero</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=n>Rational</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span> <span class=n>MultiplicativeIdentity</span> <span class=p>=&gt;</span> <span class=n>One</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=kt>int</span> <span class=n>Radix</span> <span class=p>=&gt;</span> <span class=n>TNumber</span><span class=p>.</span><span class=n>Radix</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=n>Rational</span><span class=p>()</span> <span class=p>:</span> <span class=k>this</span><span class=p>(</span><span class=n>TNumber</span><span class=p>.</span><span class=n>Zero</span><span class=p>,</span> <span class=n>TNumber</span><span class=p>.</span><span class=n>One</span><span class=p>)</span> <span class=p>{</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=n>Rational</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;</span> <span class=n>Simplify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=p>(</span><span class=n>num</span><span class=p>,</span> <span class=n>denom</span><span class=p>)</span> <span class=p>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>signNum</span> <span class=p>=</span> <span class=n>TNumber</span><span class=p>.</span><span class=n>Sign</span><span class=p>(</span><span class=n>num</span><span class=p>),</span> <span class=n>signDenom</span> <span class=p>=</span> <span class=n>TNumber</span><span class=p>.</span><span class=n>Sign</span><span class=p>(</span><span class=n>denom</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>signDenom</span> <span class=p>&lt;</span> <span class=m>0</span> <span class=p>&amp;&amp;</span> <span class=p>(</span><span class=n>signNum</span> <span class=p>&lt;</span> <span class=m>0</span> <span class=p>||</span> <span class=n>signNum</span> <span class=p>&gt;</span> <span class=m>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>num</span> <span class=p>=</span> <span class=p>-</span><span class=n>num</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>denom</span> <span class=p>=</span> <span class=p>-</span><span class=n>denom</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>num</span> <span class=p>==</span> <span class=n>TNumber</span><span class=p>.</span><span class=n>Zero</span> <span class=p>||</span> <span class=n>num</span> <span class=p>==</span> <span class=n>TNumber</span><span class=p>.</span><span class=n>One</span> <span class=p>||</span> <span class=n>num</span> <span class=p>==</span> <span class=p>-</span><span class=n>TNumber</span><span class=p>.</span><span class=n>One</span><span class=p>)</span> <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>gcd</span> <span class=p>=</span> <span class=n>GreatestCommonDivisor</span><span class=p>(</span><span class=n>num</span><span class=p>,</span> <span class=n>denom</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>gcd</span> <span class=p>&gt;</span> <span class=n>TNumber</span><span class=p>.</span><span class=n>One</span> <span class=p>?</span> <span class=k>new</span> <span class=n>Rational</span><span class=p>&lt;</span><span class=n>TNumber</span><span class=p>&gt;(</span><span class=n>num</span> <span class=p>/</span> <span class=n>gcd</span><span class=p>,</span> <span class=n>denom</span> <span class=p>/</span> <span class=n>gcd</span><span class=p>)</span> <span class=p>:</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>static</span> <span class=n>TNumber</span> <span class=n>GreatestCommonDivisor</span><span class=p>(</span><span class=n>TNumber</span> <span class=n>a</span><span class=p>,</span> <span class=n>TNumber</span> <span class=n>b</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=n>b</span> <span class=p>==</span> <span class=n>TNumber</span><span class=p>.</span><span class=n>Zero</span> <span class=p>?</span> <span class=n>a</span> <span class=p>:</span> <span class=n>GreatestCommonDivisor</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=n>a</span> <span class=p>%</span> <span class=n>b</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>static</span> <span class=k>readonly</span> <span class=kt>string</span> <span class=n>TopDigits</span> <span class=p>=</span> <span class=s>&#34;⁰¹²³⁴⁵⁶⁷⁸⁹&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>static</span> <span class=k>readonly</span> <span class=kt>string</span> <span class=n>BottomDigits</span> <span class=p>=</span> <span class=s>&#34;₀₁₂₃₄₅₆₇₈₉&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>static</span> <span class=k>readonly</span> <span class=kt>char</span> <span class=n>TopMinus</span> <span class=p>=</span> <span class=sc>&#39;⁻&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>static</span> <span class=k>readonly</span> <span class=kt>char</span> <span class=n>BottomMinus</span> <span class=p>=</span> <span class=sc>&#39;₋&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>static</span> <span class=k>readonly</span> <span class=kt>char</span> <span class=n>Divider</span> <span class=p>=</span> <span class=sc>&#39;⁄&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>bool</span> <span class=n>TryFormat</span><span class=p>(</span><span class=n>Span</span><span class=p>&lt;</span><span class=kt>char</span><span class=p>&gt;</span> <span class=n>destination</span><span class=p>,</span> <span class=k>out</span> <span class=kt>int</span> <span class=n>charsWritten</span><span class=p>,</span> <span class=n>ReadOnlySpan</span><span class=p>&lt;</span><span class=kt>char</span><span class=p>&gt;</span> <span class=n>format</span><span class=p>,</span> <span class=n>IFormatProvider</span><span class=p>?</span> <span class=n>provider</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=p>(</span><span class=n>num</span><span class=p>,</span> <span class=n>denom</span><span class=p>)</span> <span class=p>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>signNum</span> <span class=p>=</span> <span class=n>TNumber</span><span class=p>.</span><span class=n>Sign</span><span class=p>(</span><span class=n>num</span><span class=p>),</span> <span class=n>signDenom</span> <span class=p>=</span> <span class=n>TNumber</span><span class=p>.</span><span class=n>Sign</span><span class=p>(</span><span class=n>denom</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>signDenom</span> <span class=p>&lt;</span> <span class=m>0</span> <span class=p>&amp;&amp;</span> <span class=p>(</span><span class=n>signNum</span> <span class=p>&lt;</span> <span class=m>0</span> <span class=p>||</span> <span class=n>signNum</span> <span class=p>&gt;</span> <span class=m>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>num</span> <span class=p>=</span> <span class=p>-</span><span class=n>num</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>denom</span> <span class=p>=</span> <span class=p>-</span><span class=n>denom</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>provider</span> <span class=p>??=</span> <span class=n>CultureInfo</span><span class=p>.</span><span class=n>InvariantCulture</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>charsWritten</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>destination</span><span class=p>.</span><span class=n>Length</span> <span class=p>&lt;</span> <span class=m>3</span><span class=p>)</span> <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>bool</span> <span class=n>tryFormatSucceeded</span> <span class=p>=</span> <span class=n>num</span><span class=p>.</span><span class=n>TryFormat</span><span class=p>(</span><span class=n>destination</span><span class=p>,</span> <span class=k>out</span> <span class=kt>var</span> <span class=n>tryFormatCharsWritten</span><span class=p>,</span> <span class=n>format</span><span class=p>,</span> <span class=n>provider</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>charsWritten</span> <span class=p>+=</span> <span class=n>tryFormatCharsWritten</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(!</span><span class=n>tryFormatSucceeded</span> <span class=p>||</span> <span class=n>destination</span><span class=p>.</span><span class=n>Length</span> <span class=p>&lt;</span> <span class=n>charsWritten</span> <span class=p>+</span> <span class=m>2</span><span class=p>)</span> <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>numBlock</span> <span class=p>=</span> <span class=n>destination</span><span class=p>[..</span><span class=n>charsWritten</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>numBlock</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>c</span> <span class=p>=</span> <span class=n>numBlock</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(!</span><span class=n>IsSimpleDigit</span><span class=p>(</span><span class=n>c</span><span class=p>)</span> <span class=p>&amp;&amp;</span> <span class=n>c</span> <span class=p>!=</span> <span class=sc>&#39;-&#39;</span><span class=p>)</span> <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>numBlock</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>c</span> <span class=p>==</span> <span class=sc>&#39;-&#39;</span> <span class=p>?</span> <span class=n>TopMinus</span> <span class=p>:</span> <span class=n>TopDigits</span><span class=p>[</span><span class=n>c</span> <span class=p>-</span> <span class=sc>&#39;0&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>destination</span><span class=p>.</span><span class=n>Length</span> <span class=p>&lt;</span> <span class=n>charsWritten</span> <span class=p>+</span> <span class=m>2</span><span class=p>)</span> <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>destination</span><span class=p>[</span><span class=n>charsWritten</span><span class=p>++]</span> <span class=p>=</span> <span class=n>Divider</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>tryFormatSucceeded</span> <span class=p>=</span> <span class=n>denom</span><span class=p>.</span><span class=n>TryFormat</span><span class=p>(</span><span class=n>destination</span><span class=p>[</span><span class=n>charsWritten</span><span class=p>..],</span> <span class=k>out</span> <span class=n>tryFormatCharsWritten</span><span class=p>,</span> <span class=n>format</span><span class=p>,</span> <span class=n>provider</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>startOfDenomBlock</span> <span class=p>=</span> <span class=n>charsWritten</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>charsWritten</span> <span class=p>+=</span> <span class=n>tryFormatCharsWritten</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(!</span><span class=n>tryFormatSucceeded</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>denomBlock</span> <span class=p>=</span> <span class=n>destination</span><span class=p>.</span><span class=n>Slice</span><span class=p>(</span><span class=n>startOfDenomBlock</span><span class=p>,</span> <span class=n>tryFormatCharsWritten</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>denomBlock</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>c</span> <span class=p>=</span> <span class=n>denomBlock</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(!</span><span class=n>IsSimpleDigit</span><span class=p>(</span><span class=n>c</span><span class=p>)</span> <span class=p>&amp;&amp;</span> <span class=n>c</span> <span class=p>!=</span> <span class=sc>&#39;-&#39;</span><span class=p>)</span> <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>denomBlock</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>c</span> <span class=p>==</span> <span class=sc>&#39;-&#39;</span> <span class=p>?</span> <span class=n>BottomMinus</span> <span class=p>:</span> <span class=n>BottomDigits</span><span class=p>[</span><span class=n>c</span> <span class=p>-</span> <span class=sc>&#39;0&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>static</span> <span class=kt>bool</span> <span class=n>IsSimpleDigit</span><span class=p>(</span><span class=kt>char</span> <span class=n>c</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>(</span><span class=kt>uint</span><span class=p>)</span><span class=n>c</span> <span class=p>&lt;</span> <span class=m>128</span> <span class=p>&amp;&amp;</span> <span class=p>(</span><span class=kt>uint</span><span class=p>)(</span><span class=n>c</span> <span class=p>-</span> <span class=sc>&#39;0&#39;</span><span class=p>)</span> <span class=p>&lt;=</span> <span class=sc>&#39;9&#39;</span> <span class=p>-</span> <span class=sc>&#39;0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>string</span> <span class=n>ToString</span><span class=p>(</span><span class=kt>string?</span> <span class=n>format</span><span class=p>,</span> <span class=n>IFormatProvider</span><span class=p>?</span> <span class=n>formatProvider</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=k>this</span><span class=p>.</span><span class=n>FormatToString</span><span class=p>(</span><span class=n>format</span><span class=p>,</span> <span class=n>formatProvider</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>override</span> <span class=kt>string?</span> <span class=n>ToString</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>ToString</span><span class=p>(</span><span class=s>&#34;G&#34;</span><span class=p>,</span> <span class=k>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/*... remaining code omitted for brevity*/</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Now we can use <code>Rational</code> structure in our matrix:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kt>var</span> <span class=n>rationalMatrix</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Matrix</span><span class=p>&lt;</span><span class=n>Rational</span><span class=p>&lt;</span><span class=kt>int</span><span class=p>&gt;&gt;(</span>
</span></span><span class=line><span class=cl>    <span class=n>Enumerable</span><span class=p>.</span><span class=n>Range</span><span class=p>(</span><span class=m>1</span><span class=p>,</span> <span class=m>9</span><span class=p>).</span><span class=n>Select</span><span class=p>(</span><span class=n>i</span> <span class=p>=&gt;</span> <span class=k>new</span> <span class=n>Rational</span><span class=p>&lt;</span><span class=kt>int</span><span class=p>&gt;(</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=p>*</span> <span class=m>10</span> <span class=p>*</span> <span class=p>(</span><span class=n>i</span> <span class=p>%</span> <span class=m>2</span> <span class=p>==</span> <span class=m>0</span> <span class=p>?</span> <span class=m>1</span> <span class=p>:</span> <span class=p>-</span><span class=m>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=c1>//--------------------------------</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=p>*</span> <span class=m>123</span>
</span></span><span class=line><span class=cl>        <span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>ToArray</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=m>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//formatting of matrix delegates element formatting to Rational struct </span>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>text</span> <span class=p>=</span> <span class=n>rationalMatrix</span><span class=p>.</span><span class=n>ToString</span><span class=p>();</span> 
</span></span></code></pre></div><p>This will produce the following output:</p><data id=id-3 data-raw></data><h2 id=performance>Performance</h2><p>Code &ldquo;performance&rdquo; is ambiguous term. It may refer to both ease/speed of development of given feature or how said feature behaves during program runtime. Let me address the former one first as it may be easier to demonstrate</p><h3 id=speed-of-development>Speed of development</h3><p>Some time ago I&rsquo;ve create <em>generic</em> <a href=https://github.com/nemesissoft/SimpleLogisticRegression/tree/main target=_blank rel="noopener noreffer">predictor</a> that used <a href=https://en.wikipedia.org/wiki/Logistic_regression target=_blank rel="noopener noreffer">logistic regression</a>. In that context <em>&ldquo;generic&rdquo;</em> meant that it was not dedicated and could be used to solve any binary classification problem (while being universal enough that same mechanism might be employed for multi-class classification).</p><p>I decided to introduce generic math to this predictor as users may then opt to use, say, different floating point number type (like<code>System.Single</code>or<code>System.Half</code>) when it will give them similar results (for certain problems this really might be the case) but with smaller memory footprint and faster processing times. All that conversion was done on separate <a href=https://github.com/nemesissoft/SimpleLogisticRegression/tree/feature/GenericMath target=_blank rel="noopener noreffer">branch</a>.</p><p>One can observe that merely a few <a href=https://github.com/nemesissoft/SimpleLogisticRegression/compare/main...feature/GenericMath target=_blank rel="noopener noreffer">changes</a> needed to be applied. Conversion took me not more than 5 minutes. Had this coding be done with generic math in mind from the beginning - impact would have probably been even more negligible - provided that generic math is a concept known by developer (learning curve tends to be steep here)</p><h3 id=runtime-performance>Runtime performance</h3><p>Have a look at my proposal of a simple vector structures. Among them you will find dedicated version for <em>LongVector</em> (not embedded here for brevity) and dedicated version for <em>System.Double</em>:
<script type=application/javascript src="https://gist.github.com/MichalBrylka/19ae10e62d55ce7cbb2cc9ab21e7e879.js?file=DoubleVector.cs"></script></p><p>Below you will find version that uses generic math along with version that uses generic math in tandem with pointer arithmetics (<a href=https://gist.github.com/MichalBrylka/19ae10e62d55ce7cbb2cc9ab21e7e879#file-othervectors-cs target=_blank rel="noopener noreffer">Vector2.cs</a> and others were not embedded for brevity):
<script type=application/javascript src="https://gist.github.com/MichalBrylka/19ae10e62d55ce7cbb2cc9ab21e7e879.js?file=Vector1.cs"></script></p><h4 id=results>Results</h4><p>These are the results from my machine:</p><p>Category: <strong>Double</strong></p><table><thead><tr><th>Method</th><th>Size</th><th style=text-align:right>Mean [μs]</th><th style=text-align:right>Error [μs]</th><th style=text-align:right>StdDev [μs]</th><th style=text-align:right>Ratio</th></tr></thead><tbody><tr><td>DoubleBench</td><td>100</td><td style=text-align:right>8.387</td><td style=text-align:right>0.0545</td><td style=text-align:right>0.0455</td><td style=text-align:right>1.00</td></tr><tr><td>Vector1_Double</td><td>100</td><td style=text-align:right>8.462</td><td style=text-align:right>0.0117</td><td style=text-align:right>0.0104</td><td style=text-align:right>1.01</td></tr><tr><td>Vector2_Double</td><td>100</td><td style=text-align:right>7.428</td><td style=text-align:right>0.0167</td><td style=text-align:right>0.0148</td><td style=text-align:right>0.89</td></tr><tr><td>Span_Double</td><td>100</td><td style=text-align:right>7.687</td><td style=text-align:right>0.0216</td><td style=text-align:right>0.0191</td><td style=text-align:right>0.92</td></tr><tr><td>DoubleBench</td><td>10000</td><td style=text-align:right>935.063</td><td style=text-align:right>1.4331</td><td style=text-align:right>1.2704</td><td style=text-align:right>1.00</td></tr><tr><td>Vector1_Double</td><td>10000</td><td style=text-align:right>935.315</td><td style=text-align:right>2.0107</td><td style=text-align:right>1.6790</td><td style=text-align:right>1.00</td></tr><tr><td>Vector2_Double</td><td>10000</td><td style=text-align:right>935.157</td><td style=text-align:right>2.0961</td><td style=text-align:right>1.8581</td><td style=text-align:right>1.00</td></tr><tr><td>Span_Double</td><td>10000</td><td style=text-align:right>934.439</td><td style=text-align:right>2.0086</td><td style=text-align:right>1.7805</td><td style=text-align:right>1.00</td></tr></tbody></table><p>Category: <strong>Long</strong></p><table><thead><tr><th>Method</th><th>Size</th><th style=text-align:right>Mean [μs]</th><th style=text-align:right>Error [μs]</th><th style=text-align:right>StdDev [μs]</th><th style=text-align:right>Ratio</th></tr></thead><tbody><tr><td>LongBench</td><td>100</td><td style=text-align:right>4.712</td><td style=text-align:right>0.0371</td><td style=text-align:right>0.0347</td><td style=text-align:right>1.00</td></tr><tr><td>Vector1_Long</td><td>100</td><td style=text-align:right>5.616</td><td style=text-align:right>0.0367</td><td style=text-align:right>0.0306</td><td style=text-align:right>1.19</td></tr><tr><td>Vector2_Long</td><td>100</td><td style=text-align:right>5.567</td><td style=text-align:right>0.0105</td><td style=text-align:right>0.0093</td><td style=text-align:right>1.18</td></tr><tr><td>Span_Long</td><td>100</td><td style=text-align:right>4.583</td><td style=text-align:right>0.0230</td><td style=text-align:right>0.0192</td><td style=text-align:right>0.97</td></tr><tr><td>LongBench</td><td>10000</td><td style=text-align:right>430.674</td><td style=text-align:right>2.0188</td><td style=text-align:right>1.6858</td><td style=text-align:right>1.00</td></tr><tr><td>Vector1_Long</td><td>10000</td><td style=text-align:right>401.085</td><td style=text-align:right>2.8027</td><td style=text-align:right>2.4845</td><td style=text-align:right>0.93</td></tr><tr><td>Vector2_Long</td><td>10000</td><td style=text-align:right>443.050</td><td style=text-align:right>2.1181</td><td style=text-align:right>1.8776</td><td style=text-align:right>1.03</td></tr><tr><td>Span_Long</td><td>10000</td><td style=text-align:right>393.092</td><td style=text-align:right>2.3554</td><td style=text-align:right>1.9669</td><td style=text-align:right>0.91</td></tr></tbody></table><p>One can clearly see that memory-wise, they all behave the same - by not allocating anything. Types in benchmark were defined as structs. While it may not be best option for such data structures, it helps here by not obstructing our view with needless allocations).</p><p>Double benchmarks are always ~2 times slower than Long ones but that has nothing to do with generic math itself - floating-point related operations are generally slower on CPUs.</p><p>What also can be observed is that difference in processing speed is negligible. Generic math is not adding much. In case we need to optimize, we can do so by employing pointer arithmetics or (better yet) - <a href=https://learn.microsoft.com/en-us/archive/msdn-magazine/2018/january/csharp-all-about-span-exploring-a-new-net-mainstay target=_blank rel="noopener noreffer">Spans</a>.</p><p>One could argue that <code>DoubleVector</code>and <code>LongVector</code> could also benefit from using additional optimization techniques but we need to repeat them for each and every case. We might probably be more tempted to introduce optimizations when many (generic) types can benefit from these actions.</p><p>This graph summarizes in details all benchmarks performed for <code>System.Long</code> type for various vector sizes. One can clearly see that differences are almost negligible<div class=echarts id=id-4 style=width:100%;height:30rem></div></p><p>Same data, but restricted only to largest sizes:<div class=echarts id=id-5 style=width:100%;height:30rem></div></p><div class="details admonition example open"><div class="details-summary admonition-title"><i class="icon fas fa-list-ol fa-fw" aria-hidden=true></i>Source code<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>Full benchmark and results can be found under this <a href=https://gist.github.com/MichalBrylka/19ae10e62d55ce7cbb2cc9ab21e7e879 target=_blank rel="noopener noreffer">gist</a></div></div></div><h2 id=summary>Summary</h2><p>We&rsquo;ve seen how one might go about implementing generic math in their code. This matrix is not complete but quite soon I intend to finish it. It will be distributed via nuget like <a href=https://www.nuget.org/profiles/MichalBrylka target=_blank rel="noopener noreffer">my other packages</a>.</p><p>Are you still not convinced? It seems that Microsoft is already using generic math in their libraries i.e. in many places in LINQ including (but not limited to) <a href=https://github.com/dotnet/runtime/blob/c6f5267686688aeabaa84aeb02efc2b411e7d64b/src/libraries/System.Linq/src/System/Linq/Average.cs#L77 target=_blank rel="noopener noreffer">Average</a> or <a href=https://github.com/dotnet/runtime/blob/c6f5267686688aeabaa84aeb02efc2b411e7d64b/src/libraries/System.Linq/src/System/Linq/Sum.cs#L63 target=_blank rel="noopener noreffer">Sum</a>, which replaced some old and seasoned dedicated types copy-and-paste method implementations. If Microsoft is having faith in generic math, there is no reason that shouldn&rsquo;t you.</p><h2 id=bonus---physics>Bonus - physics</h2><p>This should be treated as a work-in-progress but have a look at my initial proposal on how units can now be defined in C#: <a href=https://gist.github.com/MichalBrylka/c614f567c483bc3a4e4ba5df11007366 target=_blank rel="noopener noreffer">Generic Units</a></p><h2 id=sources>Sources</h2><ul><li><a href=https://gist.github.com/MichalBrylka/0b226418e297fbe6d7413e0c812c4d19#file-program-cs target=_blank rel="noopener noreffer">Generic Matrix code</a></li><li><a href=https://www.nuget.org/packages/Nemesis.TextParsers rel="noopener noreffer" target=_blank><img src="https://img.shields.io/nuget/v/Nemesis.TextParsers.svg?style=flat-square&color=blue&logo=nuget&label=" alt="Nuget for Nemesis.TextParsers" style=vertical-align:middle>
<span>Nemesis.TextParsers</span></a> was used to provide a nice and performant <a href=https://github.com/nemesissoft/Nemesis.TextParsers/blob/3fac52a9b35856ac57e4ae6e6d854a448c7032d8/Nemesis.TextParsers/SpanSplit.cs#L290 target=_blank rel="noopener noreffer">equivalent</a> to <a href="https://learn.microsoft.com/en-us/dotnet/api/system.string.split?view=net-7.0" target=_blank rel="noopener noreffer">string.Split</a> for <code>ReadOnlySpan&lt;char></code> for parsing purposes</li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-12-05</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://michalbrylka.github.io/posts/generic-math-matrix/ data-title="Generic math extended example" data-via=michal_brylka data-hashtags=language,math,generics,csharp><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://michalbrylka.github.io/posts/generic-math-matrix/ data-hashtag=language><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://michalbrylka.github.io/posts/generic-math-matrix/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Tumblr" data-sharer=tumblr data-url=https://michalbrylka.github.io/posts/generic-math-matrix/ data-title="Generic math extended example" data-tags=language,math,generics,csharp><i class="fab fa-tumblr fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://michalbrylka.github.io/posts/generic-math-matrix/ data-title="Generic math extended example"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://michalbrylka.github.io/posts/generic-math-matrix/><i class="fab fa-reddit fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://michalbrylka.github.io/posts/generic-math-matrix/ data-title="Generic math extended example"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://michalbrylka.github.io/posts/generic-math-matrix/ data-title="Generic math extended example"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/language/>language</a>,&nbsp;<a href=/tags/math/>math</a>,&nbsp;<a href=/tags/generics/>generics</a>,&nbsp;<a href=/tags/csharp/>csharp</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/static-interface-members/ class=prev rel=prev title="Static Interface Members"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Static Interface Members</a></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.109.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://github.com/MichalBrylka target=_blank>Michał Bryłka</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://michalbrylka.disqus.com/embed.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/echarts@5.3.3/dist/echarts.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},data:{"id-1":"\u003ckbd\u003eF12\u003c/kbd\u003e","id-2":`
$$
\\begin{matrix}
1 \u0026 2 \u0026 3\\\\
4 \u0026 5 \u0026 6\\\\
7 \u0026 8 \u0026 9
\\end{matrix}
$$
`,"id-3":`
$$
\\begin{matrix}
⁻¹⁰⁄₁₂₃ \u0026  ²⁰⁄₂₄₆ \u0026 ⁻³⁰⁄₃₆₉\\\\
⁴⁰⁄₄₉₂  \u0026 ⁻⁵⁰⁄₆₁₅ \u0026  ⁶⁰⁄₇₃₈\\\\
⁻⁷⁰⁄₈₆₁ \u0026  ⁸⁰⁄₉₈₄ \u0026 ⁻⁹⁰⁄₁₁₀₇
\\end{matrix}
$$
`,"id-4":'{"grid":{"bottom":"5%","containLabel":true,"left":"5%","right":"5%","top":"20%"},"legend":{"data":["Dedicated vector","Generic vector","Generic vector with pointer arithmetics","Vector with span backing"],"top":"10%"},"series":[{"data":[0.5252,4.6899,40.6706,429.6956,4326.9663,48113.1239],"name":"Dedicated vector","type":"line"},{"data":[0.7776,5.0594,38.3465,474.6456,4693.9954,48628.9106],"name":"Generic vector","type":"line"},{"data":[0.8456,5.5831,47.7041,471.7119,4713.6924,46883.9084],"name":"Generic vector with pointer arithmetics","type":"line"},{"data":[0.8059,4.5867,36.9617,375.8776,3788.5032,43107.3873],"name":"Vector with span backing","type":"line"}],"title":{"left":"center","text":"Performance of vectors types [μs]","top":"2%"},"toolbox":{"feature":{"saveAsImage":{"title":"Save as Image"}}},"tooltip":{"trigger":"axis"},"xAxis":{"boundaryGap":false,"data":["10","100","1000","10000","100000","1000000"],"type":"category"},"yAxis":{"type":"value"}}',"id-5":'{"grid":{"bottom":"5%","containLabel":true,"left":"5%","right":"5%","top":"20%"},"legend":{"data":["Dedicated vector","Generic vector","Generic vector with pointer arithmetics","Vector with span backing"],"top":"10%"},"series":[{"data":[429.6956,4326.9663,48113.1239],"name":"Dedicated vector","type":"line"},{"data":[474.6456,4693.9954,48628.9106],"name":"Generic vector","type":"line"},{"data":[471.7119,4713.6924,46883.9084],"name":"Generic vector with pointer arithmetics","type":"line"},{"data":[375.8776,3788.5032,43107.3873],"name":"Vector with span backing","type":"line"}],"title":{"left":"center","text":"Performance of vectors types [μs]","top":"2%"},"toolbox":{"feature":{"saveAsImage":{"title":"Save as Image"}}},"tooltip":{"trigger":"axis"},"xAxis":{"boundaryGap":false,"data":["10000","100000","1000000"],"type":"category"},"yAxis":{"type":"value"}}'},echarts:{darkTheme:{backgroundColor:"rgba(41,52,65,1)",bar:{itemStyle:{barBorderColor:"#ccc",barBorderWidth:0}},boxplot:{itemStyle:{borderColor:"#ccc",borderWidth:0}},candlestick:{itemStyle:{borderColor:"#fc97af",borderColor0:"#87f7cf",borderWidth:1,color:"#fc97af",color0:"transparent"}},categoryAxis:{axisLabel:{color:"#aaaaaa",show:!0},axisLine:{lineStyle:{color:"#666666"},show:!0},axisTick:{lineStyle:{color:"#333"},show:!0},splitArea:{areaStyle:{color:["rgba(250,250,250,0.05)","rgba(200,200,200,0.02)"]},show:!1},splitLine:{lineStyle:{color:["#e6e6e6"]},show:!1}},color:["#fc97af","#87f7cf","#f7f494","#72ccff","#f7c5a0","#d4a4eb","#d2f5a6","#76f2f2"],dataZoom:{backgroundColor:"rgba(255,255,255,0)",dataBackgroundColor:"rgba(114,204,255,1)",fillerColor:"rgba(114,204,255,0.2)",handleColor:"#72ccff",handleSize:"100%",textStyle:{color:"#333333"}},funnel:{itemStyle:{borderColor:"#ccc",borderWidth:0}},gauge:{itemStyle:{borderColor:"#ccc",borderWidth:0}},geo:{emphasis:{itemStyle:{areaColor:"rgba(255,178,72,1)",borderColor:"#eb8146",borderWidth:1},label:{color:"rgb(137,52,72)"}},itemStyle:{areaColor:"#f3f3f3",borderColor:"#999999",borderWidth:.5},label:{color:"#893448"}},graph:{color:["#fc97af","#87f7cf","#f7f494","#72ccff","#f7c5a0","#d4a4eb","#d2f5a6","#76f2f2"],itemStyle:{borderColor:"#ccc",borderWidth:0},label:{color:"#293441"},lineStyle:{color:"#ffffff",width:1},smooth:!0,symbol:"emptyCircle",symbolSize:3},legend:{textStyle:{color:"#999999"}},line:{itemStyle:{borderWidth:1},lineStyle:{width:2},smooth:!0,symbol:"circle",symbolSize:6},logAxis:{axisLabel:{color:"#aaaaaa",show:!0},axisLine:{lineStyle:{color:"#666666"},show:!0},axisTick:{lineStyle:{color:"#333"},show:!0},splitArea:{areaStyle:{color:["rgba(250,250,250,0.05)","rgba(200,200,200,0.02)"]},show:!0},splitLine:{lineStyle:{color:["#e6e6e6"]},show:!0}},map:{emphasis:{itemStyle:{areaColor:"rgba(255,178,72,1)",borderColor:"#eb8146",borderWidth:1},label:{color:"rgb(137,52,72)"}},itemStyle:{areaColor:"#f3f3f3",borderColor:"#999999",borderWidth:.5},label:{color:"#893448"}},markPoint:{emphasis:{label:{color:"#293441"}},label:{color:"#293441"}},parallel:{itemStyle:{borderColor:"#ccc",borderWidth:0}},pie:{itemStyle:{borderColor:"#ccc",borderWidth:0}},radar:{itemStyle:{borderWidth:1},lineStyle:{width:2},smooth:!0,symbol:"circle",symbolSize:3},sankey:{itemStyle:{borderColor:"#ccc",borderWidth:0}},scatter:{itemStyle:{borderColor:"#ccc",borderWidth:0}},textStyle:{},timeAxis:{axisLabel:{color:"#aaaaaa",show:!0},axisLine:{lineStyle:{color:"#666666"},show:!0},axisTick:{lineStyle:{color:"#333"},show:!0},splitArea:{areaStyle:{color:["rgba(250,250,250,0.05)","rgba(200,200,200,0.02)"]},show:!1},splitLine:{lineStyle:{color:["#e6e6e6"]},show:!0}},timeline:{checkpointStyle:{borderColor:"#fc97af",color:"#fc97af"},controlStyle:{borderColor:"#87f7cf",borderWidth:.5,color:"#87f7cf"},emphasis:{controlStyle:{borderColor:"#87f7cf",borderWidth:.5,color:"#87f7cf"},itemStyle:{color:"#f7f494"},label:{color:"#87f7cf"}},itemStyle:{borderWidth:1,color:"#87f7cf"},label:{color:"#87f7cf"},lineStyle:{color:"#87f7cf",width:1}},title:{subtextStyle:{color:"#dddddd"},textStyle:{color:"#ffffff"}},toolbox:{emphasis:{iconStyle:{borderColor:"#666666"}},iconStyle:{borderColor:"#999999"}},tooltip:{axisPointer:{crossStyle:{color:"#cccccc",width:1},lineStyle:{color:"#cccccc",width:1}}},valueAxis:{axisLabel:{color:"#aaaaaa",show:!0},axisLine:{lineStyle:{color:"#666666"},show:!0},axisTick:{lineStyle:{color:"#333"},show:!0},splitArea:{areaStyle:{color:["rgba(250,250,250,0.05)","rgba(200,200,200,0.02)"]},show:!1},splitLine:{lineStyle:{color:["#e6e6e6"]},show:!0}},visualMap:{color:["#fc97af","#87f7cf"]}},lightTheme:{backgroundColor:"rgba(0,0,0,0)",bar:{itemStyle:{barBorderColor:"#ccc",barBorderWidth:0}},boxplot:{itemStyle:{borderColor:"#ccc",borderWidth:0}},candlestick:{itemStyle:{borderColor:"#d87a80",borderColor0:"#2ec7c9",borderWidth:1,color:"#d87a80",color0:"#2ec7c9"}},categoryAxis:{axisLabel:{color:"#333",show:!0},axisLine:{lineStyle:{color:"#008acd"},show:!0},axisTick:{lineStyle:{color:"#333"},show:!0},splitArea:{areaStyle:{color:["rgba(250,250,250,0.3)","rgba(200,200,200,0.3)"]},show:!1},splitLine:{lineStyle:{color:["#eee"]},show:!1}},color:["#2ec7c9","#b6a2de","#5ab1ef","#ffb980","#d87a80","#8d98b3","#e5cf0d","#97b552","#95706d","#dc69aa","#07a2a4","#9a7fd1","#588dd5","#f5994e","#c05050","#59678c","#c9ab00","#7eb00a","#6f5553","#c14089"],dataZoom:{backgroundColor:"rgba(47,69,84,0)",dataBackgroundColor:"#efefff",fillerColor:"rgba(182,162,222,0.2)",handleColor:"#008acd",handleSize:"100%",textStyle:{color:"#333333"}},funnel:{itemStyle:{borderColor:"#ccc",borderWidth:0}},gauge:{itemStyle:{borderColor:"#ccc",borderWidth:0}},geo:{emphasis:{itemStyle:{areaColor:"rgba(254,153,78,1)",borderColor:"#444",borderWidth:1},label:{color:"rgb(100,0,0)"}},itemStyle:{areaColor:"#dddddd",borderColor:"#eeeeee",borderWidth:.5},label:{color:"#d87a80"}},graph:{color:["#2ec7c9","#b6a2de","#5ab1ef","#ffb980","#d87a80","#8d98b3","#e5cf0d","#97b552","#95706d","#dc69aa","#07a2a4","#9a7fd1","#588dd5","#f5994e","#c05050","#59678c","#c9ab00","#7eb00a","#6f5553","#c14089"],itemStyle:{borderColor:"#ccc",borderWidth:0},label:{color:"#eeeeee"},lineStyle:{color:"#aaaaaa",width:1},smooth:!0,symbol:"emptyCircle",symbolSize:3},legend:{textStyle:{color:"#333333"}},line:{itemStyle:{borderWidth:1},lineStyle:{width:2},smooth:!0,symbol:"emptyCircle",symbolSize:5},logAxis:{axisLabel:{color:"#333",show:!0},axisLine:{lineStyle:{color:"#008acd"},show:!0},axisTick:{lineStyle:{color:"#333"},show:!0},splitArea:{areaStyle:{color:["rgba(250,250,250,0.3)","rgba(200,200,200,0.3)"]},show:!0},splitLine:{lineStyle:{color:["#eee"]},show:!0}},map:{emphasis:{itemStyle:{areaColor:"rgba(254,153,78,1)",borderColor:"#444",borderWidth:1},label:{color:"rgb(100,0,0)"}},itemStyle:{areaColor:"#dddddd",borderColor:"#eeeeee",borderWidth:.5},label:{color:"#d87a80"}},markPoint:{emphasis:{label:{color:"#eeeeee"}},label:{color:"#eeeeee"}},parallel:{itemStyle:{borderColor:"#ccc",borderWidth:0}},pie:{itemStyle:{borderColor:"#ccc",borderWidth:0}},radar:{itemStyle:{borderWidth:1},lineStyle:{width:2},smooth:!0,symbol:"emptyCircle",symbolSize:3},sankey:{itemStyle:{borderColor:"#ccc",borderWidth:0}},scatter:{itemStyle:{borderColor:"#ccc",borderWidth:0}},textStyle:{},timeAxis:{axisLabel:{color:"#333",show:!0},axisLine:{lineStyle:{color:"#008acd"},show:!0},axisTick:{lineStyle:{color:"#333"},show:!0},splitArea:{areaStyle:{color:["rgba(250,250,250,0.3)","rgba(200,200,200,0.3)"]},show:!1},splitLine:{lineStyle:{color:["#eee"]},show:!0}},timeline:{checkpointStyle:{borderColor:"#2ec7c9",color:"#2ec7c9"},controlStyle:{borderColor:"#008acd",borderWidth:.5,color:"#008acd"},emphasis:{controlStyle:{borderColor:"#008acd",borderWidth:.5,color:"#008acd"},itemStyle:{color:"#a9334c"},label:{color:"#008acd"}},itemStyle:{borderWidth:1,color:"#008acd"},label:{color:"#008acd"},lineStyle:{color:"#008acd",width:1}},title:{subtextStyle:{color:"#aaaaaa"},textStyle:{color:"#008acd"}},toolbox:{emphasis:{iconStyle:{borderColor:"#18a4a6"}},iconStyle:{borderColor:"#2ec7c9"}},tooltip:{axisPointer:{crossStyle:{color:"#008acd",width:1},lineStyle:{color:"#008acd",width:1}}},valueAxis:{axisLabel:{color:"#333",show:!0},axisLine:{lineStyle:{color:"#008acd"},show:!0},axisTick:{lineStyle:{color:"#333"},show:!0},splitArea:{areaStyle:{color:["rgba(250,250,250,0.3)","rgba(200,200,200,0.3)"]},show:!0},splitLine:{lineStyle:{color:["#eee"]},show:!0}},visualMap:{color:["#5ab1ef","#e0ffff"]}}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>