<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Span binary reader - Michał Bryłka | Devexcellence</title><meta name=Description content="Michał Bryłka | Devexcellence blog"><meta property="og:title" content="Span binary reader"><meta property="og:description" content="Span is marvelous way to represent contiguous memory in .NET. What it lacks is convenience in reading/writing using build in functions or dedicated reader/writer. Today I&rsquo;ll try to address the former"><meta property="og:type" content="article"><meta property="og:url" content="https://michalbrylka.github.io/posts/span-binary-reader/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-04T00:00:00+00:00"><meta property="article:modified_time" content="2023-01-04T00:00:00+00:00"><meta property="og:site_name" content="Michał Bryłka | Devexcellence"><meta name=twitter:card content="summary"><meta name=twitter:title content="Span binary reader"><meta name=twitter:description content="Span is marvelous way to represent contiguous memory in .NET. What it lacks is convenience in reading/writing using build in functions or dedicated reader/writer. Today I&rsquo;ll try to address the former"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://michalbrylka.github.io/posts/span-binary-reader/><link rel=prev href=https://michalbrylka.github.io/posts/commit-driven-development/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Span binary reader","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/michalbrylka.github.io\/posts\/span-binary-reader\/"},"genre":"posts","keywords":"csharp, performance","wordcount":682,"url":"https:\/\/michalbrylka.github.io\/posts\/span-binary-reader\/","datePublished":"2023-01-04T00:00:00+00:00","dateModified":"2023-01-04T00:00:00+00:00","license":"\u0026copy; Copyright 2019-2022 Michał Bryłka","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Michał Bryłka"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Michał Bryłka | Devexcellence"><span class=header-title-pre><i class="fa-solid fa-code"></i></span>Devexcellence</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Michał Bryłka | Devexcellence"><span class=header-title-pre><i class="fa-solid fa-code"></i></span>Devexcellence</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Span binary reader</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/MichalBrylka title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Michał Bryłka</a></span>&nbsp;<span class=post-category>included in <a href=/categories/programming/><i class="far fa-folder fa-fw" aria-hidden=true></i>programming</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-01-04>2023-01-04</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;682 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;4 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#reader-design>Reader design</a></li><li><a href=#summary>Summary</a></li><li><a href=#sources>Sources</a></li></ul></nav></div></div><div class=content id=content><p><a href=https://learn.microsoft.com/en-us/archive/msdn-magazine/2018/january/csharp-all-about-span-exploring-a-new-net-mainstay target=_blank rel="noopener noreffer">Span/ReadOnlySpan</a> represent marvelous way to represent contiguous memory in .NET be it managed and unmanaged resources, strings or stack-allocated values. What they lack however is convenience in reading/writing using build in functions or dedicated reader/writer. Today I&rsquo;ll try to address the former utility structure.</p><h2 id=reader-design>Reader design</h2><p>In order to create a wrapper around <a href=https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/builtin-types/ref-struct target=_blank rel="noopener noreffer">ref-structure</a> we need to define ref struct as well:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>ref</span> <span class=k>struct</span> <span class=nc>SpanBinaryReader</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>readonly</span> <span class=n>ReadOnlySpan</span><span class=p>&lt;</span><span class=kt>byte</span><span class=p>&gt;</span> <span class=n>_buffer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=kt>int</span> <span class=n>_position</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Current position</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>int</span> <span class=n>Position</span> <span class=p>=&gt;</span> <span class=n>_position</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Length of underlying buffer</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>int</span> <span class=n>Length</span> <span class=p>=&gt;</span> <span class=n>_buffer</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=n>SpanBinaryReader</span><span class=p>(</span><span class=n>ReadOnlySpan</span><span class=p>&lt;</span><span class=kt>byte</span><span class=p>&gt;</span> <span class=n>buffer</span><span class=p>,</span> <span class=kt>int</span> <span class=n>position</span> <span class=p>=</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>_buffer</span> <span class=p>=</span> <span class=n>buffer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>_position</span> <span class=p>=</span> <span class=n>position</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>In order to be familiar to developer we will try to follow <a href="https://learn.microsoft.com/en-us/dotnet/api/system.io.binaryreader?view=net-7.0" target=_blank rel="noopener noreffer">BinaryReader</a> API logic by defining similar seek/position features:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=c1>// Reset current position to default (0)</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>void</span> <span class=n>Reset</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>_position</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Advance (or retreat) current position by given amount</span>
</span></span><span class=line><span class=cl><span class=c1>// Offset parameter indicates number of bytes to advance position by </span>
</span></span><span class=line><span class=cl><span class=c1>// or retreat by in case of negative numbers</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>void</span> <span class=n>Seek</span><span class=p>(</span><span class=kt>int</span> <span class=n>offset</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>newPosition</span> <span class=p>=</span> <span class=n>_position</span> <span class=p>+</span> <span class=n>offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>newPosition</span> <span class=p>&lt;</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>ArgumentOutOfRangeException</span><span class=p>(</span><span class=n>nameof</span><span class=p>(</span><span class=n>offset</span><span class=p>),</span> <span class=n>offset</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=s>$&#34;After advancing by {nameof(offset)} parameter, &#34;</span> <span class=p>+</span> 
</span></span><span class=line><span class=cl>             <span class=s>&#34;position should point to non-negative number&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>_position</span> <span class=p>=</span> <span class=n>newPosition</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Determines if end of buffer was reached </span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=kt>bool</span> <span class=n>IsEnd</span> <span class=p>=&gt;</span> <span class=n>_position</span> <span class=p>&gt;=</span> <span class=n>_buffer</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span>
</span></span></code></pre></div><p>as well as <em>ReadXXX</em> methods:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=c1>// Reads 1 byte from underlying stream. Returns byte read or -1 if EOB is reached</span>
</span></span><span class=line><span class=cl><span class=na>[MethodImpl(MethodImplOptions.AggressiveInlining)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=kt>int</span> <span class=n>ReadByte</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>_position</span> <span class=p>&gt;=</span> <span class=n>_buffer</span><span class=p>.</span><span class=n>Length</span> <span class=p>?</span> <span class=p>-</span><span class=m>1</span> <span class=p>:</span> <span class=n>_buffer</span><span class=p>[</span><span class=n>_position</span><span class=p>++];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Reads one little endian 16 bits integer from underlying stream</span>
</span></span><span class=line><span class=cl><span class=na>[MethodImpl(MethodImplOptions.AggressiveInlining)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=kt>short</span> <span class=n>ReadInt16</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>BinaryPrimitives</span><span class=p>.</span><span class=n>ReadInt16LittleEndian</span><span class=p>(</span><span class=n>ReadExactly</span><span class=p>(</span><span class=m>2</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Reads one little endian 32 bits integer from underlying stream</span>
</span></span><span class=line><span class=cl><span class=na>[MethodImpl(MethodImplOptions.AggressiveInlining)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=kt>int</span> <span class=n>ReadInt32</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>BinaryPrimitives</span><span class=p>.</span><span class=n>ReadInt32LittleEndian</span><span class=p>(</span><span class=n>ReadExactly</span><span class=p>(</span><span class=m>4</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Reads one little endian 64 bits integer from underlying stream</span>
</span></span><span class=line><span class=cl><span class=na>[MethodImpl(MethodImplOptions.AggressiveInlining)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=kt>long</span> <span class=n>ReadInt64</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>BinaryPrimitives</span><span class=p>.</span><span class=n>ReadInt64LittleEndian</span><span class=p>(</span><span class=n>ReadExactly</span><span class=p>(</span><span class=m>8</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Reads boolean value from underlying stream. Returns true if byte read is non-zero, false otherwise</span>
</span></span><span class=line><span class=cl><span class=na>[MethodImpl(MethodImplOptions.AggressiveInlining)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=kt>bool</span> <span class=n>ReadBoolean</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>ReadExactly</span><span class=p>(</span><span class=m>1</span><span class=p>)</span> <span class=k>is</span> <span class=kt>var</span> <span class=n>slice</span> <span class=p>&amp;&amp;</span> <span class=n>slice</span><span class=p>[</span><span class=m>0</span><span class=p>]</span> <span class=p>!=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Reads one little endian 32 bits floating number from underlying stream</span>
</span></span><span class=line><span class=cl><span class=na>[MethodImpl(MethodImplOptions.AggressiveInlining)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=kt>float</span> <span class=n>ReadSingle</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>BinaryPrimitives</span><span class=p>.</span><span class=n>ReadSingleLittleEndian</span><span class=p>(</span><span class=n>ReadExactly</span><span class=p>(</span><span class=m>4</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Reads one little endian 64 bits floating number from underlying stream</span>
</span></span><span class=line><span class=cl><span class=na>[MethodImpl(MethodImplOptions.AggressiveInlining)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=kt>double</span> <span class=n>ReadDouble</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>BinaryPrimitives</span><span class=p>.</span><span class=n>ReadDoubleLittleEndian</span><span class=p>(</span><span class=n>ReadExactly</span><span class=p>(</span><span class=m>8</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Reads one little endian 128 bits decimal number from underlying stream</span>
</span></span><span class=line><span class=cl><span class=na>[MethodImpl(MethodImplOptions.AggressiveInlining)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=kt>decimal</span> <span class=n>ReadDecimal</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>lo</span> <span class=p>=</span> <span class=n>ReadInt32</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>mid</span> <span class=p>=</span> <span class=n>ReadInt32</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>hi</span> <span class=p>=</span> <span class=n>ReadInt32</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>flags</span> <span class=p>=</span> <span class=n>ReadInt32</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=kt>decimal</span><span class=p>(</span><span class=n>lo</span><span class=p>,</span> <span class=n>mid</span><span class=p>,</span> <span class=n>hi</span><span class=p>,</span> <span class=p>(</span><span class=n>flags</span> <span class=p>&amp;</span> <span class=m>0</span><span class=n>b_1000_0000_0000_0000_0000_0000_0000_0000</span><span class=p>)</span> <span class=p>!=</span> <span class=m>0</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                       <span class=p>(</span><span class=kt>byte</span><span class=p>)((</span><span class=n>flags</span> <span class=p>&gt;&gt;</span> <span class=m>16</span><span class=p>)</span> <span class=p>&amp;</span> <span class=m>0xFF</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>and remaining helper <em>Read</em> methods (code might me collapsed as it&rsquo;s a bit longer):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=c1>// Reads a sequence of bytes from the current stream and advances the position within the stream by the number of bytes read.</span>
</span></span><span class=line><span class=cl><span class=na>[MethodImpl(MethodImplOptions.AggressiveInlining)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=kt>int</span> <span class=n>ReadTo</span><span class=p>(</span><span class=n>Span</span><span class=p>&lt;</span><span class=kt>byte</span><span class=p>&gt;</span> <span class=n>buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>n</span> <span class=p>=</span> <span class=n>Math</span><span class=p>.</span><span class=n>Min</span><span class=p>(</span><span class=n>Length</span> <span class=p>-</span> <span class=n>Position</span><span class=p>,</span> <span class=n>buffer</span><span class=p>.</span><span class=n>Length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=p>&lt;=</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>_buffer</span><span class=p>.</span><span class=n>Slice</span><span class=p>(</span><span class=n>_position</span><span class=p>,</span> <span class=n>n</span><span class=p>).</span><span class=n>CopyTo</span><span class=p>(</span><span class=n>buffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>_position</span> <span class=p>+=</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Reads buffer of given size at most</span>
</span></span><span class=line><span class=cl><span class=na>[MethodImpl(MethodImplOptions.AggressiveInlining)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=n>ReadOnlySpan</span><span class=p>&lt;</span><span class=kt>byte</span><span class=p>&gt;</span> <span class=n>Read</span><span class=p>(</span><span class=kt>int</span> <span class=n>numBytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>numBytes</span> <span class=p>&lt;</span> <span class=m>0</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>ArgumentOutOfRangeException</span><span class=p>(</span><span class=n>nameof</span><span class=p>(</span><span class=n>numBytes</span><span class=p>),</span> 
</span></span><span class=line><span class=cl>                                              <span class=s>$&#34;&#39;{numBytes}&#39; should be non negative&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>n</span> <span class=p>=</span> <span class=n>Math</span><span class=p>.</span><span class=n>Min</span><span class=p>(</span><span class=n>Length</span> <span class=p>-</span> <span class=n>Position</span><span class=p>,</span> <span class=n>numBytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=p>&lt;=</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ReadOnlySpan</span><span class=p>&lt;</span><span class=kt>byte</span><span class=p>&gt;.</span><span class=n>Empty</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>result</span> <span class=p>=</span> <span class=n>_buffer</span><span class=p>.</span><span class=n>Slice</span><span class=p>(</span><span class=n>_position</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>_position</span> <span class=p>+=</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Reads buffer of exact given size </span>
</span></span><span class=line><span class=cl><span class=na>[MethodImpl(MethodImplOptions.AggressiveInlining)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=n>ReadOnlySpan</span><span class=p>&lt;</span><span class=kt>byte</span><span class=p>&gt;</span> <span class=n>ReadExactly</span><span class=p>(</span><span class=kt>int</span> <span class=n>numBytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>numBytes</span> <span class=p>&lt;</span> <span class=m>1</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>ArgumentOutOfRangeException</span><span class=p>(</span><span class=n>nameof</span><span class=p>(</span><span class=n>numBytes</span><span class=p>),</span> <span class=s>$&#34;&#39;{numBytes}&#39; should be at least 1&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>newPosition</span> <span class=p>=</span> <span class=n>_position</span> <span class=p>+</span> <span class=n>numBytes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>newPosition</span> <span class=p>&gt;</span> <span class=n>_buffer</span><span class=p>.</span><span class=n>Length</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>ArgumentOutOfRangeException</span><span class=p>(</span><span class=n>nameof</span><span class=p>(</span><span class=n>numBytes</span><span class=p>),</span> 
</span></span><span class=line><span class=cl>            <span class=s>$&#34;Not enough data to read {numBytes} bytes from underlying buffer&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>span</span> <span class=p>=</span> <span class=n>_buffer</span><span class=p>.</span><span class=n>Slice</span><span class=p>(</span><span class=n>_position</span><span class=p>,</span> <span class=n>numBytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>_position</span> <span class=p>=</span> <span class=n>newPosition</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>span</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Returns remaining bytes from underlying buffer</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=n>ReadOnlySpan</span><span class=p>&lt;</span><span class=kt>byte</span><span class=p>&gt;</span> <span class=n>Remaining</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>_buffer</span><span class=p>.</span><span class=n>Slice</span><span class=p>(</span><span class=n>_position</span><span class=p>,</span> <span class=n>_buffer</span><span class=p>.</span><span class=n>Length</span> <span class=p>-</span> <span class=n>_position</span><span class=p>);</span>
</span></span></code></pre></div><h2 id=summary>Summary</h2><p>We were able to define a utility structure that could help in easy reading of data from spans so that neither high performance nor convenience are hindered. Next time we will see how these routines can help in solving real life performance issue 🚀.</p><p>Stay tuned for more info 🖖.</p><h2 id=sources>Sources</h2><ul><li><a href=https://github.com/nemesissoft/Nemesis.Essentials/blob/70e1f4817654b6f16589315337e60fbd64d0c651/Nemesis.Essentials/Design/SpanBinaryReader.cs target=_blank rel="noopener noreffer">SpanBinaryReader sources</a></li><li><a href=https://github.com/nemesissoft/Nemesis.Essentials/blob/70e1f4817654b6f16589315337e60fbd64d0c651/Nemesis.Essentials.Tests/SpanBinaryReaderTests.cs target=_blank rel="noopener noreffer">SpanBinaryReader tests</a></li><li><a href=https://www.nuget.org/packages/Nemesis.Essentials rel="noopener noreffer" target=_blank><img src="https://img.shields.io/nuget/v/Nemesis.Essentials.svg?style=flat-square&color=blue&logo=nuget&label=" alt="Nuget for Nemesis.Essentials" style=vertical-align:middle>
<span>Nemesis.Essentials</span></a> package contains SpanBinaryReader and other classes that should be contained in .NET but somehow are not</li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-01-04</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://michalbrylka.github.io/posts/span-binary-reader/ data-title="Span binary reader" data-via=michal_brylka data-hashtags=csharp,performance><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://michalbrylka.github.io/posts/span-binary-reader/ data-hashtag=csharp><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://michalbrylka.github.io/posts/span-binary-reader/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Tumblr" data-sharer=tumblr data-url=https://michalbrylka.github.io/posts/span-binary-reader/ data-title="Span binary reader" data-tags=csharp,performance><i class="fab fa-tumblr fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://michalbrylka.github.io/posts/span-binary-reader/ data-title="Span binary reader"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://michalbrylka.github.io/posts/span-binary-reader/><i class="fab fa-reddit fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://michalbrylka.github.io/posts/span-binary-reader/ data-title="Span binary reader"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://michalbrylka.github.io/posts/span-binary-reader/ data-title="Span binary reader"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/csharp/>csharp</a>,&nbsp;<a href=/tags/performance/>performance</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/commit-driven-development/ class=prev rel=prev title="Commitment driven development"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Commitment driven development</a></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.109.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://github.com/MichalBrylka target=_blank>Michał Bryłka</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://michalbrylka.disqus.com/embed.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>