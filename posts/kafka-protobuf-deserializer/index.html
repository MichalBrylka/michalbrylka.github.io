<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Kafka Protobuf Deserializer - Michał Bryłka | Devexcellence</title><meta name=Description content="Michał Bryłka | Devexcellence blog"><meta property="og:title" content="Kafka Protobuf Deserializer"><meta property="og:description" content="Protobuf is very efficient serialization format. It can really open it&rsquo;s wings when underlying serializer is using it in optimal way."><meta property="og:type" content="article"><meta property="og:url" content="https://michalbrylka.github.io/posts/kafka-protobuf-deserializer/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-09T00:00:00+00:00"><meta property="article:modified_time" content="2023-01-09T00:00:00+00:00"><meta property="og:site_name" content="Michał Bryłka | Devexcellence"><meta name=twitter:card content="summary"><meta name=twitter:title content="Kafka Protobuf Deserializer"><meta name=twitter:description content="Protobuf is very efficient serialization format. It can really open it&rsquo;s wings when underlying serializer is using it in optimal way."><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://michalbrylka.github.io/posts/kafka-protobuf-deserializer/><link rel=prev href=https://michalbrylka.github.io/posts/span-binary-reader/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Kafka Protobuf Deserializer","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/michalbrylka.github.io\/posts\/kafka-protobuf-deserializer\/"},"genre":"posts","keywords":"csharp, performance, kafka, protobuf","wordcount":904,"url":"https:\/\/michalbrylka.github.io\/posts\/kafka-protobuf-deserializer\/","datePublished":"2023-01-09T00:00:00+00:00","dateModified":"2023-01-09T00:00:00+00:00","license":"\u0026copy; Copyright 2019-2022 Michał Bryłka","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Michał Bryłka"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Michał Bryłka | Devexcellence"><span class=header-title-pre><i class="fa-solid fa-code"></i></span>Devexcellence</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Michał Bryłka | Devexcellence"><span class=header-title-pre><i class="fa-solid fa-code"></i></span>Devexcellence</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Kafka Protobuf Deserializer</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/MichalBrylka title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Michał Bryłka</a></span>&nbsp;<span class=post-category>included in <a href=/categories/programming/><i class="far fa-folder fa-fw" aria-hidden=true></i>programming</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-01-09>2023-01-09</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;904 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;5 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#deserializer>Deserializer</a></li><li><a href=#benchmarks>Benchmarks</a><ul><li><a href=#unit-benchmarks>Unit benchmarks</a></li><li><a href=#full-operation-benchmarks>Full operation benchmarks</a></li></ul></li><li><a href=#summary>Summary</a></li><li><a href=#sources>Sources</a></li></ul></nav></div></div><div class=content id=content><p><a href=https://en.wikipedia.org/wiki/Protocol_Buffers target=_blank rel="noopener noreffer">Protocol buffers</a> (aka. <em>protobuf</em> for short) is very efficient serialization format. Usually implementations provided by library maintainers (i.e. Protobuf ports for various frameworks) are optimal and are only getting better with time. Recently I needed to use Confluent Kafka&rsquo;s implementation of protobuf deserializer and to my astonishment, deserialization operation is not optimal.
Deserialization operation the one that my project needed the most as we were producing messages in off-work times but main system is consuming them in high-traffic periods. Let&rsquo;s see how we might remedy this issue.</p><h2 id=deserializer>Deserializer</h2><p>Luckily for us, <a href=https://www.nuget.org/packages/Confluent.Kafka rel="noopener noreffer" target=_blank><img src="https://img.shields.io/nuget/v/Confluent.Kafka.svg?style=flat-square&color=blue&logo=nuget&label=" alt="Nuget for Confluent.Kafka" style=vertical-align:middle>
<span>Confluent.Kafka</span></a> package is open source and can be found <a href=https://github.com/confluentinc/confluent-kafka-dotnet target=_blank rel="noopener noreffer">here</a>. Indeed, upon inspection of <a href=https://github.com/confluentinc/confluent-kafka-dotnet/blob/7c913b7da125a7e3ea0295505aeb11829dcfd408/src/Confluent.SchemaRegistry.Serdes.Protobuf/ProtobufDeserializer.cs#L97 target=_blank rel="noopener noreffer">ProtobufDeserializer.cs</a> we can suspect that our culprit are:</p><ul><li>data.ToArray();</li><li>using (var stream = new MemoryStream(array))</li><li>using (var reader = new BinaryReader(stream))</li></ul><p>These design decision were probably caused by the fact that there was no convenient and official API for reading data from <a href=https://learn.microsoft.com/en-us/archive/msdn-magazine/2018/january/csharp-all-about-span-exploring-a-new-net-mainstay target=_blank rel="noopener noreffer">Span/ReadOnlySpan</a>. There is few unofficial ones, you can read about my approach <a href=https://michalbrylka.github.io/posts/span-binary-reader/ rel>here</a>.</p><p>Fortunately for us, Confluent made Kafka to be really nicely composable so we can provide our own deserializer. The only thing we need to read upon deserialization are:</p><ol><li>Magic byte (zero) to indicate a message with Confluent Platform framing</li><li>4 byte schema ID. Since this is not needed as we know deserialized type&rsquo;s metadata (this can be taken from generic type) - we can safely ignore this portion of data (but stream pointer needs to move)</li><li>Unsigned/Signed variable-length encoded integers (<a href=https://en.wikipedia.org/wiki/Variable-length_quantity target=_blank rel="noopener noreffer">Varint</a>) that denotes array length - and then subsequently reading these indices</li><li>Reading payload itself - this can be delegated to underlying Protobuf library (by Google in my/Confluent&rsquo;s case)</li></ol><p>So our Deserialize method can look like that:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=n>T</span><span class=p>?</span> <span class=n>Deserialize</span><span class=p>(</span><span class=n>ReadOnlySpan</span><span class=p>&lt;</span><span class=kt>byte</span><span class=p>&gt;</span> <span class=n>data</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>isNull</span><span class=p>,</span> <span class=n>SerializationContext</span> <span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>isNull</span><span class=p>)</span> <span class=k>return</span> <span class=k>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=n>Length</span> <span class=p>&lt;</span> <span class=m>6</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>InvalidDataException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Expecting data framing of length 6 bytes or more but total data size is &#34;</span> <span class=p>+</span>
</span></span><span class=line><span class=cl>            <span class=s>$&#34;{data.Length} bytes&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>spanReader</span> <span class=p>=</span> <span class=k>new</span> <span class=n>SpanBinaryReader</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>magicByte</span> <span class=p>=</span> <span class=n>spanReader</span><span class=p>.</span><span class=n>ReadByte</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>magicByte</span> <span class=p>!=</span> <span class=n>MagicByte</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>InvalidDataException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s>$&#34;Expecting message {context.Component} with Confluent Schema Registry framing.&#34;</span> <span class=p>+</span>
</span></span><span class=line><span class=cl>            <span class=s>$&#34;Magic byte was {magicByte}, expecting {MagicByte}&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// A schema is not required to deserialize protobuf messages since the serialized data includes </span>
</span></span><span class=line><span class=cl>    <span class=c1>// tag and type information, which is enough for the IMessage&lt;T&gt; implementation to deserialize </span>
</span></span><span class=line><span class=cl>    <span class=c1>// the data (even if the schema has evolved). </span>
</span></span><span class=line><span class=cl>    <span class=c1>// Schema Id is thus unused. Just advancing by 4 bytes is enough    </span>
</span></span><span class=line><span class=cl>    <span class=n>spanReader</span><span class=p>.</span><span class=n>Seek</span><span class=p>(</span><span class=m>4</span><span class=p>);</span> <span class=c1>//var _schemaId = IPAddress.NetworkToHostOrder(spanReader.ReadInt32());</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Read the index array length, then all of the indices. These are not needed, </span>
</span></span><span class=line><span class=cl>    <span class=c1>// but parsing them is the easiest way to seek to the start of the serialized data</span>
</span></span><span class=line><span class=cl>    <span class=c1>// because they are varints.</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>indicesLength</span> <span class=p>=</span> <span class=n>_useDeprecatedFormat</span> 
</span></span><span class=line><span class=cl>        <span class=p>?</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>spanReader</span><span class=p>.</span><span class=n>ReadUnsignedVarint</span><span class=p>()</span> 
</span></span><span class=line><span class=cl>        <span class=p>:</span> <span class=n>spanReader</span><span class=p>.</span><span class=n>ReadVarint</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>indicesLength</span><span class=p>;</span> <span class=p>++</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>_useDeprecatedFormat</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>spanReader</span><span class=p>.</span><span class=n>ReadUnsignedVarint</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=n>spanReader</span><span class=p>.</span><span class=n>ReadVarint</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>_parser</span><span class=p>.</span><span class=n>ParseFrom</span><span class=p>(</span><span class=n>spanReader</span><span class=p>.</span><span class=n>Remaining</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Full implementation can be found <a href=https://github.com/nemesissoft/KafkaProtobufSyncOverAsyncPerf/blob/a286a1f9cc2bb084e151d677bc507b2000b97c80/KafkaDeserPerf/Deserializers/EfficientProtobufDeserializer.cs target=_blank rel="noopener noreffer">here</a>. During optimizations I&rsquo;ve noticed that Confluent&rsquo;s implementation only implements<code>IAsyncDeserializer&lt;></code>whereas implementing<code>IDeserializer&lt;></code>should be sufficient - we are not doing any async work there.</p><h2 id=benchmarks>Benchmarks</h2><h3 id=unit-benchmarks>Unit benchmarks</h3><p><a href=https://github.com/nemesissoft/KafkaProtobufSyncOverAsyncPerf/blob/6e7235e7489e67b712b4dfd326a646a0030e9417/KafkaDeserPerf/DeserializerBenchmarks.cs target=_blank rel="noopener noreffer">This</a> benchmark tests what the performance and memory footprint of every approach are. Full results are located in the same file, let me just present excerpt of it (pay no attention to NonAlloc* benchmarks, they we just there for tests):</p><table><thead><tr><th>Method</th><th style=text-align:right>Mean</th><th style=text-align:right>Error</th><th style=text-align:right>StdDev</th><th style=text-align:right>Ratio</th><th style=text-align:right>Gen 0</th><th style=text-align:right>Gen 1</th><th style=text-align:right>Allocated</th></tr></thead><tbody><tr><td>Confluent</td><td style=text-align:right>12,087.8 ns</td><td style=text-align:right>117.93 ns</td><td style=text-align:right>110.31 ns</td><td style=text-align:right>1.00</td><td style=text-align:right>8.2779</td><td style=text-align:right>0.1678</td><td style=text-align:right>52,003 B</td></tr><tr><td>EfficientAsync</td><td style=text-align:right>4,995.7 ns</td><td style=text-align:right>52.32 ns</td><td style=text-align:right>48.94 ns</td><td style=text-align:right>0.41</td><td style=text-align:right>0.9689</td><td style=text-align:right>-</td><td style=text-align:right>6,080 B</td></tr><tr><td>EfficientSync</td><td style=text-align:right>4,838.4 ns</td><td style=text-align:right>80.18 ns</td><td style=text-align:right>75.00 ns</td><td style=text-align:right>0.40</td><td style=text-align:right>0.8545</td><td style=text-align:right>-</td><td style=text-align:right>5,360 B</td></tr></tbody></table><p>Especially after presenting same data on interactive chart:<div class=echarts id=id-1 style=width:100%;height:30rem></div></p><p>one can clearly see the trend that Confluent&rsquo;s implementation is adding (unnecessary) allocations and partially due to that they are significantly slower.
Moreover, my synchronous version is <em>only</em> slightly (<em>&ldquo;negligibly&rdquo;</em>) faster than my async counterpart. But since there is really no point of using async here - synchronous deserializer might me our variant of choice.</p><h3 id=full-operation-benchmarks>Full operation benchmarks</h3><p>Ok we see where this is going. Performance benefits are visible but one can argue that they might not be significant. After all, Kafka internally allocates a lot of things (message itself, TopicPartitionOffset, ConsumeResult etc.). They all <em>clearly</em> would dwarf performance benefits we&rsquo;ve just obtained. Let&rsquo;s measure that. <a href=https://github.com/nemesissoft/KafkaProtobufSyncOverAsyncPerf/blob/6e7235e7489e67b712b4dfd326a646a0030e9417/KafkaDeserPerf/FullDeserializerBenchmarks.cs target=_blank rel="noopener noreffer">Here</a> I tried to recreate the whole pipeline that Confluent&rsquo;s Kafka performs upon message deserialization. These are the results:</p><table><thead><tr><th>Method</th><th style=text-align:right>Mean</th><th style=text-align:right>Error</th><th style=text-align:right>StdDev</th><th style=text-align:right>Ratio</th><th style=text-align:right>Gen 0</th><th style=text-align:right>Gen 1</th><th style=text-align:right>Allocated</th></tr></thead><tbody><tr><td>Create</td><td style=text-align:right>1,049.5 ns</td><td style=text-align:right>18.40 ns</td><td style=text-align:right>26.97 ns</td><td style=text-align:right>1.00</td><td style=text-align:right>0.9937</td><td style=text-align:right>0.0019</td><td style=text-align:right>6,240 B</td></tr><tr><td>Confluent</td><td style=text-align:right>8,116.3 ns</td><td style=text-align:right>92.92 ns</td><td style=text-align:right>82.37 ns</td><td style=text-align:right>7.65</td><td style=text-align:right>8.6670</td><td style=text-align:right>0.1221</td><td style=text-align:right>54,403 B</td></tr><tr><td>EfficientAsync</td><td style=text-align:right>5,137.8 ns</td><td style=text-align:right>96.98 ns</td><td style=text-align:right>99.59 ns</td><td style=text-align:right>4.85</td><td style=text-align:right>1.3504</td><td style=text-align:right>-</td><td style=text-align:right>8,480 B</td></tr><tr><td>EfficientSync</td><td style=text-align:right>4,993.0 ns</td><td style=text-align:right>34.52 ns</td><td style=text-align:right>32.29 ns</td><td style=text-align:right>4.71</td><td style=text-align:right>1.2360</td><td style=text-align:right>-</td><td style=text-align:right>7,760 B</td></tr></tbody></table><p><em>Create</em> benchmark is there just to demonstrate amount of memory/performance that deserialize operation would have without any calls to Protobuf deserializer. Again, the difference both in performance and memory allocations is clear&mldr;</p><h2 id=summary>Summary</h2><p>We&rsquo;ve demonstrated that eliminating allocations allows us to harvest low hanging fruits in performance realm. We are using this deserializer on production and it seem&rsquo;s fine. I did not prepare any Nuget package with that solution but can provide one if the need arrives. I filed an <a href=https://github.com/confluentinc/confluent-kafka-dotnet/issues/1701 target=_blank rel="noopener noreffer">issue</a> and offered a pull request. So far a claim was offered that <em>at some point in the future this might be implemented</em>. Fingers crossed. Upvote 👍 if you care to include my change in official release.<br>Subscribe to this issue on Github to stay tuned for more info 🖖.</p><h2 id=sources>Sources</h2><ul><li><a href=https://github.com/nemesissoft/KafkaProtobufSyncOverAsyncPerf/blob/a286a1f9cc2bb084e151d677bc507b2000b97c80/KafkaDeserPerf/Deserializers/EfficientProtobufDeserializer.cs target=_blank rel="noopener noreffer">EfficientProtobufDeserializer</a></li><li><a href=https://github.com/nemesissoft/KafkaProtobufSyncOverAsyncPerf/blob/6e7235e7489e67b712b4dfd326a646a0030e9417/Tests/EfficientProtobufDeserializerTests.cs target=_blank rel="noopener noreffer">Tests</a></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-01-09</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://michalbrylka.github.io/posts/kafka-protobuf-deserializer/ data-title="Kafka Protobuf Deserializer" data-via=michal_brylka data-hashtags=csharp,performance,kafka,protobuf><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://michalbrylka.github.io/posts/kafka-protobuf-deserializer/ data-hashtag=csharp><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://michalbrylka.github.io/posts/kafka-protobuf-deserializer/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Tumblr" data-sharer=tumblr data-url=https://michalbrylka.github.io/posts/kafka-protobuf-deserializer/ data-title="Kafka Protobuf Deserializer" data-tags=csharp,performance,kafka,protobuf><i class="fab fa-tumblr fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://michalbrylka.github.io/posts/kafka-protobuf-deserializer/ data-title="Kafka Protobuf Deserializer"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://michalbrylka.github.io/posts/kafka-protobuf-deserializer/><i class="fab fa-reddit fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://michalbrylka.github.io/posts/kafka-protobuf-deserializer/ data-title="Kafka Protobuf Deserializer"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://michalbrylka.github.io/posts/kafka-protobuf-deserializer/ data-title="Kafka Protobuf Deserializer"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/csharp/>csharp</a>,&nbsp;<a href=/tags/performance/>performance</a>,&nbsp;<a href=/tags/kafka/>kafka</a>,&nbsp;<a href=/tags/protobuf/>protobuf</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/span-binary-reader/ class=prev rel=prev title="Span binary reader"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Span binary reader</a></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.109.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://github.com/MichalBrylka target=_blank>Michał Bryłka</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://michalbrylka.disqus.com/embed.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/echarts@5.3.3/dist/echarts.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},data:{"id-1":'{"grid":{"bottom":"5%","containLabel":true,"left":"5%","right":"5%","top":"20%"},"legend":{"data":["Confluent","Efficient (async version)","Efficient (synchronous version)"],"top":"10%"},"series":[{"data":[1228.1,12087.8,122244.2],"name":"Confluent","type":"line"},{"data":[506.1,4995.7,49830.6],"name":"Efficient (async version)","type":"line"},{"data":[487.4,4838.4,47873.2],"name":"Efficient (synchronous version)","type":"line"}],"title":{"left":"center","text":"Performance of deserializers for Kafka using Protobuf scheme [ns]","top":"2%"},"toolbox":{"feature":{"saveAsImage":{"title":"Save as Image"}}},"tooltip":{"trigger":"axis"},"xAxis":{"boundaryGap":false,"data":["1","10","100"],"type":"category"},"yAxis":{"type":"value"}}'},echarts:{darkTheme:{backgroundColor:"rgba(41,52,65,1)",bar:{itemStyle:{barBorderColor:"#ccc",barBorderWidth:0}},boxplot:{itemStyle:{borderColor:"#ccc",borderWidth:0}},candlestick:{itemStyle:{borderColor:"#fc97af",borderColor0:"#87f7cf",borderWidth:1,color:"#fc97af",color0:"transparent"}},categoryAxis:{axisLabel:{color:"#aaaaaa",show:!0},axisLine:{lineStyle:{color:"#666666"},show:!0},axisTick:{lineStyle:{color:"#333"},show:!0},splitArea:{areaStyle:{color:["rgba(250,250,250,0.05)","rgba(200,200,200,0.02)"]},show:!1},splitLine:{lineStyle:{color:["#e6e6e6"]},show:!1}},color:["#fc97af","#87f7cf","#f7f494","#72ccff","#f7c5a0","#d4a4eb","#d2f5a6","#76f2f2"],dataZoom:{backgroundColor:"rgba(255,255,255,0)",dataBackgroundColor:"rgba(114,204,255,1)",fillerColor:"rgba(114,204,255,0.2)",handleColor:"#72ccff",handleSize:"100%",textStyle:{color:"#333333"}},funnel:{itemStyle:{borderColor:"#ccc",borderWidth:0}},gauge:{itemStyle:{borderColor:"#ccc",borderWidth:0}},geo:{emphasis:{itemStyle:{areaColor:"rgba(255,178,72,1)",borderColor:"#eb8146",borderWidth:1},label:{color:"rgb(137,52,72)"}},itemStyle:{areaColor:"#f3f3f3",borderColor:"#999999",borderWidth:.5},label:{color:"#893448"}},graph:{color:["#fc97af","#87f7cf","#f7f494","#72ccff","#f7c5a0","#d4a4eb","#d2f5a6","#76f2f2"],itemStyle:{borderColor:"#ccc",borderWidth:0},label:{color:"#293441"},lineStyle:{color:"#ffffff",width:1},smooth:!0,symbol:"emptyCircle",symbolSize:3},legend:{textStyle:{color:"#999999"}},line:{itemStyle:{borderWidth:1},lineStyle:{width:2},smooth:!0,symbol:"circle",symbolSize:6},logAxis:{axisLabel:{color:"#aaaaaa",show:!0},axisLine:{lineStyle:{color:"#666666"},show:!0},axisTick:{lineStyle:{color:"#333"},show:!0},splitArea:{areaStyle:{color:["rgba(250,250,250,0.05)","rgba(200,200,200,0.02)"]},show:!0},splitLine:{lineStyle:{color:["#e6e6e6"]},show:!0}},map:{emphasis:{itemStyle:{areaColor:"rgba(255,178,72,1)",borderColor:"#eb8146",borderWidth:1},label:{color:"rgb(137,52,72)"}},itemStyle:{areaColor:"#f3f3f3",borderColor:"#999999",borderWidth:.5},label:{color:"#893448"}},markPoint:{emphasis:{label:{color:"#293441"}},label:{color:"#293441"}},parallel:{itemStyle:{borderColor:"#ccc",borderWidth:0}},pie:{itemStyle:{borderColor:"#ccc",borderWidth:0}},radar:{itemStyle:{borderWidth:1},lineStyle:{width:2},smooth:!0,symbol:"circle",symbolSize:3},sankey:{itemStyle:{borderColor:"#ccc",borderWidth:0}},scatter:{itemStyle:{borderColor:"#ccc",borderWidth:0}},textStyle:{},timeAxis:{axisLabel:{color:"#aaaaaa",show:!0},axisLine:{lineStyle:{color:"#666666"},show:!0},axisTick:{lineStyle:{color:"#333"},show:!0},splitArea:{areaStyle:{color:["rgba(250,250,250,0.05)","rgba(200,200,200,0.02)"]},show:!1},splitLine:{lineStyle:{color:["#e6e6e6"]},show:!0}},timeline:{checkpointStyle:{borderColor:"#fc97af",color:"#fc97af"},controlStyle:{borderColor:"#87f7cf",borderWidth:.5,color:"#87f7cf"},emphasis:{controlStyle:{borderColor:"#87f7cf",borderWidth:.5,color:"#87f7cf"},itemStyle:{color:"#f7f494"},label:{color:"#87f7cf"}},itemStyle:{borderWidth:1,color:"#87f7cf"},label:{color:"#87f7cf"},lineStyle:{color:"#87f7cf",width:1}},title:{subtextStyle:{color:"#dddddd"},textStyle:{color:"#ffffff"}},toolbox:{emphasis:{iconStyle:{borderColor:"#666666"}},iconStyle:{borderColor:"#999999"}},tooltip:{axisPointer:{crossStyle:{color:"#cccccc",width:1},lineStyle:{color:"#cccccc",width:1}}},valueAxis:{axisLabel:{color:"#aaaaaa",show:!0},axisLine:{lineStyle:{color:"#666666"},show:!0},axisTick:{lineStyle:{color:"#333"},show:!0},splitArea:{areaStyle:{color:["rgba(250,250,250,0.05)","rgba(200,200,200,0.02)"]},show:!1},splitLine:{lineStyle:{color:["#e6e6e6"]},show:!0}},visualMap:{color:["#fc97af","#87f7cf"]}},lightTheme:{backgroundColor:"rgba(0,0,0,0)",bar:{itemStyle:{barBorderColor:"#ccc",barBorderWidth:0}},boxplot:{itemStyle:{borderColor:"#ccc",borderWidth:0}},candlestick:{itemStyle:{borderColor:"#d87a80",borderColor0:"#2ec7c9",borderWidth:1,color:"#d87a80",color0:"#2ec7c9"}},categoryAxis:{axisLabel:{color:"#333",show:!0},axisLine:{lineStyle:{color:"#008acd"},show:!0},axisTick:{lineStyle:{color:"#333"},show:!0},splitArea:{areaStyle:{color:["rgba(250,250,250,0.3)","rgba(200,200,200,0.3)"]},show:!1},splitLine:{lineStyle:{color:["#eee"]},show:!1}},color:["#2ec7c9","#b6a2de","#5ab1ef","#ffb980","#d87a80","#8d98b3","#e5cf0d","#97b552","#95706d","#dc69aa","#07a2a4","#9a7fd1","#588dd5","#f5994e","#c05050","#59678c","#c9ab00","#7eb00a","#6f5553","#c14089"],dataZoom:{backgroundColor:"rgba(47,69,84,0)",dataBackgroundColor:"#efefff",fillerColor:"rgba(182,162,222,0.2)",handleColor:"#008acd",handleSize:"100%",textStyle:{color:"#333333"}},funnel:{itemStyle:{borderColor:"#ccc",borderWidth:0}},gauge:{itemStyle:{borderColor:"#ccc",borderWidth:0}},geo:{emphasis:{itemStyle:{areaColor:"rgba(254,153,78,1)",borderColor:"#444",borderWidth:1},label:{color:"rgb(100,0,0)"}},itemStyle:{areaColor:"#dddddd",borderColor:"#eeeeee",borderWidth:.5},label:{color:"#d87a80"}},graph:{color:["#2ec7c9","#b6a2de","#5ab1ef","#ffb980","#d87a80","#8d98b3","#e5cf0d","#97b552","#95706d","#dc69aa","#07a2a4","#9a7fd1","#588dd5","#f5994e","#c05050","#59678c","#c9ab00","#7eb00a","#6f5553","#c14089"],itemStyle:{borderColor:"#ccc",borderWidth:0},label:{color:"#eeeeee"},lineStyle:{color:"#aaaaaa",width:1},smooth:!0,symbol:"emptyCircle",symbolSize:3},legend:{textStyle:{color:"#333333"}},line:{itemStyle:{borderWidth:1},lineStyle:{width:2},smooth:!0,symbol:"emptyCircle",symbolSize:5},logAxis:{axisLabel:{color:"#333",show:!0},axisLine:{lineStyle:{color:"#008acd"},show:!0},axisTick:{lineStyle:{color:"#333"},show:!0},splitArea:{areaStyle:{color:["rgba(250,250,250,0.3)","rgba(200,200,200,0.3)"]},show:!0},splitLine:{lineStyle:{color:["#eee"]},show:!0}},map:{emphasis:{itemStyle:{areaColor:"rgba(254,153,78,1)",borderColor:"#444",borderWidth:1},label:{color:"rgb(100,0,0)"}},itemStyle:{areaColor:"#dddddd",borderColor:"#eeeeee",borderWidth:.5},label:{color:"#d87a80"}},markPoint:{emphasis:{label:{color:"#eeeeee"}},label:{color:"#eeeeee"}},parallel:{itemStyle:{borderColor:"#ccc",borderWidth:0}},pie:{itemStyle:{borderColor:"#ccc",borderWidth:0}},radar:{itemStyle:{borderWidth:1},lineStyle:{width:2},smooth:!0,symbol:"emptyCircle",symbolSize:3},sankey:{itemStyle:{borderColor:"#ccc",borderWidth:0}},scatter:{itemStyle:{borderColor:"#ccc",borderWidth:0}},textStyle:{},timeAxis:{axisLabel:{color:"#333",show:!0},axisLine:{lineStyle:{color:"#008acd"},show:!0},axisTick:{lineStyle:{color:"#333"},show:!0},splitArea:{areaStyle:{color:["rgba(250,250,250,0.3)","rgba(200,200,200,0.3)"]},show:!1},splitLine:{lineStyle:{color:["#eee"]},show:!0}},timeline:{checkpointStyle:{borderColor:"#2ec7c9",color:"#2ec7c9"},controlStyle:{borderColor:"#008acd",borderWidth:.5,color:"#008acd"},emphasis:{controlStyle:{borderColor:"#008acd",borderWidth:.5,color:"#008acd"},itemStyle:{color:"#a9334c"},label:{color:"#008acd"}},itemStyle:{borderWidth:1,color:"#008acd"},label:{color:"#008acd"},lineStyle:{color:"#008acd",width:1}},title:{subtextStyle:{color:"#aaaaaa"},textStyle:{color:"#008acd"}},toolbox:{emphasis:{iconStyle:{borderColor:"#18a4a6"}},iconStyle:{borderColor:"#2ec7c9"}},tooltip:{axisPointer:{crossStyle:{color:"#008acd",width:1},lineStyle:{color:"#008acd",width:1}}},valueAxis:{axisLabel:{color:"#333",show:!0},axisLine:{lineStyle:{color:"#008acd"},show:!0},axisTick:{lineStyle:{color:"#333"},show:!0},splitArea:{areaStyle:{color:["rgba(250,250,250,0.3)","rgba(200,200,200,0.3)"]},show:!0},splitLine:{lineStyle:{color:["#eee"]},show:!0}},visualMap:{color:["#5ab1ef","#e0ffff"]}}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>